<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHG Yem…ôk Talon Sistemi - QR Kodlar</title>
    
    <!-- QRCode.js CDN -->
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* LOGIN S∆èHƒ∞F∆èSƒ∞ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            text-align: center;
            animation: slideUp 0.5s;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        /* ∆èSAS S∆èHƒ∞F∆è */
        .main-app {
            display: none;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .qr-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .qr-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .qr-card.used {
            opacity: 0.6;
            background: #ffebee;
            border-color: #ef5350;
        }

        .qr-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .qr-wrapper {
            width: 200px;
            height: 200px;
            margin: 15px auto;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 200px;
        }

        .qr-wrapper img, .qr-wrapper canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-unused {
            background: #4caf50;
            color: white;
        }

        .status-used {
            background: #f44336;
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            width: auto;
            padding: 12px 30px;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            width: auto;
            padding: 12px 30px;
        }

        .btn-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: auto;
            padding: 12px 30px;
        }

        .refresh-info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #1976d2;
        }

        .refresh-info strong {
            display: block;
            margin-bottom: 5px;
        }

        @media print {
            .no-print { display: none !important; }
            .qr-card { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <!-- LOGIN S∆èHƒ∞F∆èSƒ∞ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h1>üçΩÔ∏è GHG Yem…ôk</h1>
            <p>Elektron talon sistemi</p>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="firstName">Ad</label>
                    <input type="text" id="firstName" placeholder="M…ôs…ôl…ôn: ∆èfqan" required autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="lastName">Soyad</label>
                    <input type="text" id="lastName" placeholder="M…ôs…ôl…ôn: S…ôf…ôrov" required autocomplete="off">
                </div>
                
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    Daxil Ol
                </button>
            </form>
            
            <div class="error-message" id="errorMsg">
                ‚ùå Siz …ôm…ôkda≈ü siyahƒ±sƒ±nda tapƒ±lmadƒ±nƒ±z!
            </div>
            
            <div class="success-message" id="successMsg">
                ‚úÖ Uƒüurlu! Y√∂nl…ôndirilir...
            </div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; color: #999; font-size: 12px;">
                <p>üí° ƒ∞pucu: Ad v…ô soyadƒ± d√ºzg√ºn yazƒ±n.<br>Ata adƒ± avtomatik …ôlav…ô olunacaq.</p>
            </div>
        </div>
    </div>

    <!-- QR KODLAR S∆èHƒ∞F∆èSƒ∞ -->
    <div class="main-app" id="mainApp">
        <div class="container">
            <div class="header">
                <div class="user-info no-print">
                    <span>üë§ <strong id="displayName"></strong></span>
                    <span style="color: #ddd;">|</span>
                    <span>üÜî <span id="displayId"></span></span>
                    <button class="logout-btn" onclick="logout()">√áƒ±xƒ±≈ü</button>
                </div>
                <h1>üçΩÔ∏è Yem…ôk Talonlarƒ±m</h1>
            </div>

            <!-- QR Kodlar B√∂lm…ôsi -->
            <div class="section">
                <!-- ‚úÖ AVTOMATIK YENƒ∞L∆èM∆è ƒ∞NFORMASƒ∞YASI -->
                <div class="refresh-info">
                    <strong>üîÑ Avtomatik Yenil…ônm…ô</strong>
                    Siz h…ôr g√ºn yeni talonlar alacaqsƒ±nƒ±z<br>
                    <small>Son yenil…ônm…ô: <span id="lastRefresh">Hesablanƒ±r...</span></small>
                </div>

                <h2>üé´ M…ônim 4 Yem…ôk Talonum</h2>
                <p style="color: #666; margin-bottom: 20px;">H…ôr talon yalnƒ±z bir d…ôf…ô istifad…ô edil…ô bil…ôr</p>
                
                <div id="qrContainer" class="qr-grid">
                    <!-- 4 QR kod bura g…ôl…ôc…ôk -->
                </div>
                
                <div class="no-print" style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-success" onclick="printQRs()">üñ®Ô∏è √áap Et</button>
                    <button class="btn btn-warning" onclick="downloadQRs()">üíæ Y√ºkl…ô</button>
                    <button class="btn btn-info" onclick="manualRefreshQRs()">üîÑ ƒ∞ndi Yenil…ô</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // GLOBAL KONFƒ∞QURASƒ∞YA
        // ============================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwkCc2MyyxfulJ178DCyITRFzj8Y52lP0njFQcHT9hLoXV2M223XNwK0NYKHf8zklg/exec';
        
        let currentEmployee = null;
        let allEmployees = [];
        
        const TICKET_MAP_REVERSE = {
            'breakfast': 'b',
            'lunch': 'l',
            'dinner': 'd',
            'dry': 'dr'
        };

        const TICKET_TYPES = [
            { id: 'breakfast', name: 'S…ôh…ôr Yem…ôyi', icon: 'üåÖ', time: '06:00-10:00' },
            { id: 'lunch', name: 'G√ºnorta Yem…ôyi', icon: 'üåû', time: '12:00-15:00' },
            { id: 'dinner', name: 'Ax≈üam Yem…ôyi', icon: 'üåô', time: '18:00-21:00' },
            { id: 'dry', name: 'Quru Talon', icon: 'üì¶', time: 'H…ôr zaman' }
        ];

        // ============================================================
        // AVTOMATIK YENƒ∞L∆èM∆è FUNKSIYALARI
        // ============================================================
        function checkAndRefreshDailyTickets() {
            const empId = currentEmployee.id;
            const lastRefreshDate = localStorage.getItem(`lastRefresh_${empId}`);
            const today = new Date().toDateString();

            // ‚úÖ ∆èg…ôr bug√ºn h…ôl…ô yenil…ônm…ôyibs…ô, yenil…ô
            if (lastRefreshDate !== today) {
                console.log('üîÑ H…ôr g√ºn yenil…ônm…ô ba≈ülanƒ±r...');
                refreshAllTickets();
                localStorage.setItem(`lastRefresh_${empId}`, today);
                updateRefreshInfo();
            } else {
                console.log('‚úÖ Bug√ºn artƒ±q yenil…ônib');
                updateRefreshInfo();
            }
        }

        function refreshAllTickets() {
            const empId = currentEmployee.id;
            
            // B√ºt√ºn talonlarƒ± sƒ±fƒ±rla (istifad…ô edilmi≈ü olanlarƒ± da)
            TICKET_TYPES.forEach(type => {
                currentEmployee.tickets[type.id] = {
                    id: `${empId}_${type.id}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type: type.id,
                    used: false,
                    usedDate: null,
                    usedTime: null
                };
            });

            // LocalStorage-…ô saxla
            localStorage.setItem(`tickets_${empId}`, JSON.stringify(currentEmployee.tickets));

            console.log('‚úÖ B√ºt√ºn talonlar yenil…ôndi!');
            generateQRCardsHTML();
        }

        function manualRefreshQRs() {
            if (confirm('B√ºt√ºn talonlarƒ±nƒ±zƒ± yenil…ôtm…ôk ist…ôdiyiniz…ô …ômin misiniz?')) {
                refreshAllTickets();
                alert('‚úÖ Talonlar yenil…ôndi!');
            }
        }

        function updateRefreshInfo() {
            const empId = currentEmployee.id;
            const lastRefreshDate = localStorage.getItem(`lastRefresh_${empId}`);
            const lastRefreshEl = document.getElementById('lastRefresh');

            if (lastRefreshDate) {
                lastRefreshEl.textContent = new Date(lastRefreshDate).toLocaleDateString('az-AZ');
            } else {
                lastRefreshEl.textContent = 'Yoxdur (bug√ºn yenil…ôn…ôc…ôk)';
            }
        }

        // ============================================================
        // LOGƒ∞N FUNKSIYALARI
        // ============================================================
        async function handleLogin(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = 'Yoxlanƒ±lƒ±r... <span class="loading-spinner"></span>';
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            try {
                const response = await fetch(API_URL + '?t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error('API baƒülantƒ± x…ôtasƒ±: ' + response.status);
                }
                
                const data = await response.json();
                
                if (data.status !== 'success') {
                    throw new Error(data.message || 'M…ôlumat alƒ±na bilm…ôdi');
                }
                
                allEmployees = data.employees || [];
                
                const searchName = `${firstName} ${lastName}`.toLowerCase();
                const foundEmployee = allEmployees.find(emp => {
                    const fullNameLower = emp.fullName.toLowerCase();
                    return fullNameLower.startsWith(searchName);
                });
                
                if (foundEmployee) {
                    currentEmployee = {
                        id: foundEmployee.id,
                        fullName: foundEmployee.fullName,
                        firstName: firstName,
                        lastName: lastName
                    };
                    
                    const savedTickets = localStorage.getItem(`tickets_${currentEmployee.id}`);
                    if (savedTickets) {
                        currentEmployee.tickets = JSON.parse(savedTickets);
                    } else {
                        currentEmployee.tickets = generateTickets(currentEmployee.id);
                    }
                    
                    // ‚úÖ YENIL∆èNM   KONTROL ET
                    checkAndRefreshDailyTickets();
                    
                    // ‚úÖ SCANNER M∆èLUMATINI SAX
                    localStorage.setItem('currentEmployeeId', currentEmployee.id);
                    localStorage.setItem(`employee_${currentEmployee.id}`, JSON.stringify(currentEmployee));
                    
                    successMsg.style.display = 'block';
                    
                    setTimeout(() => {
                        showMainApp();
                    }, 1000);
                    
                } else {
                    errorMsg.textContent = `‚ùå "${firstName} ${lastName}" …ôm…ôkda≈ü siyahƒ±sƒ±nda tapƒ±lmadƒ±!`;
                    errorMsg.style.display = 'block';
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = 'Daxil Ol';
                }
                
            } catch (error) {
                console.error('Login x…ôtasƒ±:', error);
                errorMsg.textContent = '‚ùå X…ôta: ' + error.message;
                errorMsg.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Daxil Ol';
            }
        }

        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            document.getElementById('displayName').textContent = currentEmployee.fullName;
            document.getElementById('displayId').textContent = currentEmployee.id;
            
            generateQRCardsHTML();
            updateRefreshInfo();
        }

        function logout() {
            currentEmployee = null;
            allEmployees = [];
            localStorage.removeItem('currentEmployeeId');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('loginForm').reset();
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('successMsg').style.display = 'none';
            document.getElementById('loginBtn').disabled = false;
            document.getElementById('loginBtn').innerHTML = 'Daxil Ol';
        }

        function generateTickets(empId) {
            const tickets = {};
            TICKET_TYPES.forEach(type => {
                tickets[type.id] = {
                    id: `${empId}_${type.id}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type: type.id,
                    used: false,
                    usedDate: null,
                    usedTime: null
                };
            });
            return tickets;
        }

        // ============================================================
        // QR KOD YARATMA FUNKSIYALARI
        // ============================================================
        function generateQRCardsHTML() {
            const container = document.getElementById('qrContainer');
            
            if (!container) {
                console.error('‚ùå qrContainer element tapƒ±lmadƒ±!');
                return;
            }
            
            container.innerHTML = '';
            
            TICKET_TYPES.forEach((type, index) => {
                const ticket = currentEmployee.tickets[type.id];
                const isUsed = ticket.used;
                
                const card = document.createElement('div');
                card.className = `qr-card ${isUsed ? 'used' : ''}`;
                card.id = `card-${type.id}`;
                
                const wrapperId = `wrapper-${type.id}`;
                
                let cardHTML = `
                    <h3>${type.icon} ${type.name}</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">üïê ${type.time}</p>
                    <div class="qr-wrapper" id="${wrapperId}"></div>
                    <span class="status-badge ${isUsed ? 'status-used' : 'status-unused'}">
                        ${isUsed ? '‚ùå ƒ∞stifad…ô Edilib' : '‚úÖ Aktiv'}
                    </span>
                `;
                
                if (isUsed) {
                    cardHTML += `
                        <p style="margin-top:10px;font-size:12px;color:#666;">
                            üìÖ ${ticket.usedDate}<br>
                            üïê ${ticket.usedTime}
                        </p>
                    `;
                }
                
                card.innerHTML = cardHTML;
                container.appendChild(card);
                
                if (!isUsed) {
                    setTimeout(() => {
                        createQRCode(type, ticket, wrapperId);
                    }, 200 + (index * 300));
                } else {
                    const wrapper = document.getElementById(wrapperId);
                    if (wrapper) {
                        wrapper.innerHTML = '<div style="font-size:80px;color:#f44336;">‚ùå</div>';
                    }
                }
            });
        }

        function createQRCode(type, ticket, wrapperId) {
            const wrapper = document.getElementById(wrapperId);
            
            if (!wrapper) {
                console.error(`‚ùå Wrapper element tapƒ±lmadƒ±: ${wrapperId}`);
                return;
            }
            
            if (typeof QRCode === 'undefined') {
                console.error('‚ùå QRCode k√ºt√ºphan…ôsi y√ºkl…ônm…ôdi!');
                wrapper.innerHTML = `<div style="padding:20px;text-align:center;color:red;"><strong>QRCode Y√ºkl…ônm…ôdi</strong></div>`;
                return;
            }
            
            const ticketIdShort = ticket.id.split('_')[3] || '0';
            const typeCode = TICKET_MAP_REVERSE[type.id];
            const qrData = `${currentEmployee.id}|${typeCode}|${ticketIdShort}`;
            
            console.log(`‚úÖ QR yaradƒ±lƒ±r: ${type.name}`);
            
            wrapper.innerHTML = '';
            
            try {
                new QRCode(wrapper, {
                    text: qrData,
                    width: 140,
                    height: 140,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.L
                });
                
                console.log(`‚úÖ QR uƒüurla yaradƒ±ldƒ±: ${type.name}`);
                
            } catch (error) {
                console.error(`‚ùå QR yaratma x…ôtasƒ±:`, error);
                wrapper.innerHTML = `<div style="padding:20px;text-align:center;color:red;"><strong>QR X…ôtasƒ±</strong></div>`;
            }
        }

        function printQRs() {
            window.print();
        }

        function downloadQRs() {
            TICKET_TYPES.forEach((type, index) => {
                const canvases = document.querySelectorAll('.qr-wrapper canvas');
                if (canvases[index]) {
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.download = `${currentEmployee.id}_${type.name}.png`;
                        link.href = canvases[index].toDataURL('image/png');
                        link.click();
                    }, index * 300);
                }
            });
        }
    </script>
</body>

</html>
