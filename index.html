<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GHG Yem…ôk Skaner</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;min-height:100vh}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px;text-align:center}
    .header h1{font-size:1.3em}
    .container{max-width:600px;margin:0 auto;padding:15px}
    .scanner-box{background:#fff;border-radius:20px;padding:15px;margin-bottom:15px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    #reader{width:100%;border-radius:16px;overflow:hidden}
    .status{text-align:center;padding:12px;margin-top:10px;border-radius:12px;font-weight:600;font-size:.95em}
    .status-waiting{background:#fff3e0;color:#e65100}
    .status-scanning{background:#e3f2fd;color:#1565c0}
    .status-success{background:#e8f5e9;color:#2e7d32}
    .status-warning{background:#fff3e0;color:#f57c00}
    .status-error{background:#ffebee;color:#c62828}

    .result-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;justify-content:center;align-items:center;padding:20px}
    .result-card{background:#fff;border-radius:24px;padding:26px;width:100%;max-width:420px;text-align:center}
    .result-icon{width:90px;height:90px;border-radius:50%;margin:0 auto 18px;display:flex;align-items:center;justify-content:center;font-size:46px}
    .result-success .result-icon{background:#e8f5e9;color:#4caf50}
    .result-warning .result-icon{background:#fff3e0;color:#ff9800}
    .result-error .result-icon{background:#ffebee;color:#f44336}
    .result-title{font-size:1.3em;font-weight:800;margin-bottom:14px}
    .result-details{background:#f5f5f5;border-radius:16px;padding:16px;margin-bottom:14px;text-align:left}
    .detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e0e0e0}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:#666;font-size:.9em}
    .detail-value{color:#333;font-weight:700;font-size:.95em}

    .btn{border:none;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer;width:100%}
    .btn-confirm{background:#4caf50;color:#fff;margin-top:10px}
    .btn-close{background:#e0e0e0;color:#111;margin-top:10px}

    .countdown{font-size:2.2em;font-weight:800;color:#667eea;margin-top:10px}
    .countdown-text{color:#999;font-size:.9em;margin-top:5px}

    .last-scan{background:#fff;border-radius:20px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .last-scan h2{font-size:1.1em;color:#333;margin-bottom:12px}

    .search-wrap{display:flex;gap:10px;margin-bottom:12px}
    .search-input{
      flex:1;
      border:1px solid #e5e7eb;
      background:#fafafa;
      border-radius:14px;
      padding:12px 14px;
      font-weight:700;
      outline:none;
      font-size:14px;
    }
    .search-input:focus{border-color:#667eea;background:#fff}

    .scan-item{display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee}
    .scan-item:last-child{border-bottom:none}
    .scan-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;margin-right:12px;flex-shrink:0}
    .scan-icon.ok{background:#e8f5e9;color:#4caf50}
    .scan-icon.warn{background:#fff3e0;color:#ff9800}
    .scan-icon.err{background:#ffebee;color:#f44336}
    .scan-info{flex:1;min-width:0}
    .scan-name{font-weight:800;color:#333;font-size:.95em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .scan-detail{color:#666;font-size:.8em;margin-top:2px}
    .scan-time{color:#999;font-size:.75em;margin-top:2px}
  </style>
</head>
<body>
  <div class="header"><h1>üçΩÔ∏è GHG Yem…ôk Skaner</h1></div>

  <div class="container">
    <div class="scanner-box">
      <div id="reader"></div>
      <div class="status status-waiting" id="status">QR kod g√∂zl…ônilir...</div>
    </div>

    <div class="last-scan">
      <h2>üìã Son skan edil…ônl…ôr (bu g√ºn)</h2>
      <div class="search-wrap">
        <input id="searchInput" class="search-input" placeholder="Ad / ID il…ô axtar..." autocomplete="off" />
      </div>
      <div id="scanList">
        <div style="text-align:center;color:#999;padding:20px;">Y√ºkl…ônir...</div>
      </div>
    </div>
  </div>

  <div class="result-overlay" id="resultOverlay">
    <div class="result-card" id="resultCard">
      <div class="result-icon" id="resultIcon">‚úì</div>
      <div class="result-title" id="resultTitle">T…ôsdiql…ôndi</div>

      <div class="result-details">
        <div class="detail-row"><span class="detail-label">∆èm…ôkda≈ü:</span><span class="detail-value" id="detailName">-</span></div>
        <div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value" id="detailId">-</span></div>
        <div class="detail-row"><span class="detail-label">Talon:</span><span class="detail-value" id="detailTicket">-</span></div>
        <div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value" id="detailStatus">-</span></div>
      </div>

      <button class="btn btn-confirm" id="confirmBtn" style="display:none;">‚úÖ T…ôsdiq et</button>
      <button class="btn btn-close" id="closeBtn">Baƒüla</button>

      <div class="countdown" id="countdown" style="display:none;">5</div>
      <div class="countdown-text" id="countdownText" style="display:none;">saniy…ô sonra skaner…ô qayƒ±dƒ±lƒ±r</div>
    </div>
  </div>

  <script>
    // ‚úÖ BURANI m√ºtl…ôq d…ôyi≈ü:
    // Apps Script ‚Üí Deploy ‚Üí Manage deployments ‚Üí Web app URL (‚Ä¶/exec)
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzjsIZLUf6sVMgPWVCJT91DvOSIuD_DCQWabzgMJd2vocvZ-qlV4Z-QJMRU-lvnA5Oz/exec';

    const COUNTDOWN_SECONDS = 5;
    const LAST_QR_COOLDOWN_MS = 900;
    const DRY_TTL_MS = 24 * 60 * 60 * 1000;

    let isProcessing = false;
    let scanHistory = [];
    let html5QrCode = null;
    let countdownInterval = null;

    let pendingConfirmToken = null;
    let pendingConfirmQrData = null;
    let pendingConfirmMeta = null;

    let lastQrText = '';
    let lastQrAt = 0;

    const dryCountMap = new Map(); // qrData -> {count, ts}

    function isDryQR(qrData){
      const parts = String(qrData || '').split('|');
      const code = parts[2];
      const last = parts[5];
      return code === 'Q' || last === 'dry' || String(qrData).includes('|Q|') || String(qrData).includes('|dry');
    }

    function getDryCount(qrData){
      const row = dryCountMap.get(qrData);
      if (!row) return 0;
      if (Date.now() - row.ts > DRY_TTL_MS){ dryCountMap.delete(qrData); return 0; }
      return row.count || 0;
    }
    function setDryCount(qrData, count){
      if (!qrData) return;
      dryCountMap.set(qrData, {count, ts: Date.now()});
    }

    function fetchJSONP(url, {timeoutMs=12000, retry=1} = {}) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        const script = document.createElement('script');
        script.async = true;

        let timer = null;
        let finished = false;

        function cleanup(){
          if (timer) clearTimeout(timer);
          timer = null;
          try{ if (window[cb]) delete window[cb]; }catch(e){}
          try{ if (script && script.parentNode) script.parentNode.removeChild(script); }catch(e){}
        }

        function fail(err){
          if (finished) return;
          finished = true;
          cleanup();
          if (retry > 0) {
            return resolve(fetchJSONP(url, {timeoutMs, retry: retry-1}));
          }
          reject(err);
        }

        window[cb] = (data) => {
          if (finished) return;
          finished = true;
          cleanup();
          resolve(data);
        };

        timer = setTimeout(() => fail(new Error('Timeout')), timeoutMs);
        script.onerror = () => fail(new Error('Load error'));

        const nonce = Date.now();
        script.src = url
          + (url.includes('?') ? '&' : '?')
          + 'callback=' + cb
          + '&t=' + nonce;

        document.head.appendChild(script);
      });
    }

    function updateStatus(type, text){
      const s = document.getElementById('status');
      s.className = 'status status-' + type;
      s.textContent = text;
    }

    function escapeHtml_(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function renderScanList(){
      const list = document.getElementById('scanList');
      const q = String(document.getElementById('searchInput').value || '').trim().toLowerCase();

      const filtered = scanHistory.filter(scan => {
        if (!q) return true;
        const name = String(scan.name || '').toLowerCase();
        const id = String(scan.id || '').toLowerCase();
        return name.includes(q) || id.includes(q);
      });

      if (!filtered.length){
        list.innerHTML = `<div style="text-align:center;color:#999;padding:20px;">He√ß n…ô tapƒ±lmadƒ±</div>`;
        return;
      }

      list.innerHTML = filtered.map(scan=>{
        let icon='‚úì', cls='ok';
        if (scan.err) { icon='‚úï'; cls='err'; }
        else if (scan.warn) { icon='‚ö†'; cls='warn'; }

        return `
          <div class="scan-item">
            <div class="scan-icon ${cls}">${icon}</div>
            <div class="scan-info">
              <div class="scan-name">${escapeHtml_(scan.name)}</div>
              <div class="scan-detail">${escapeHtml_(scan.id)} ${scan.type ? '| ' + escapeHtml_(scan.type) : ''} | ${escapeHtml_(scan.msg)}</div>
              <div class="scan-time">${escapeHtml_(scan.time)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function setTodayScansFromServerItems(items){
      scanHistory = (Array.isArray(items) ? items : []).map(it => {
        const name = it.adSoyad || '-';
        const id = it.empId || '-';
        const type = it.ticketType || '-';
        const msg = it.statusText || '-';
        // ‚úÖ Saatƒ± Date() etm…ôd…ôn g√∂st…ôririk (1899 problemi YOX)
        const time = it.time ? ('Saat ' + String(it.time)) : '';
        const stLower = String(msg).toLowerCase();
        const err = stLower.includes('x…ôta') || stLower.includes('error');
        const warn = stLower.includes('t…ôkrar') || stLower.includes('x…ôb…ôrdarlƒ±q') || stLower.includes('confirm') || stLower.includes('t…ôsdiq t…ôl…ôb');
        return { name, id, type, msg, time, err, warn: (!err && warn) };
      });

      renderScanList();
    }

    async function loadTodayScans(){
      try{
        const res = await fetchJSONP(`${SHEET_API_URL}?action=getTodayScans&limit=200`, { timeoutMs: 12000, retry: 1 });
        if (!res || res.status !== 'success') throw new Error(res?.message || 'getTodayScans error');
        setTodayScansFromServerItems(res.items || []);
      }catch(e){
        const list = document.getElementById('scanList');
        list.innerHTML = `<div style="text-align:center;color:#999;padding:20px;">Bu g√ºn√ºn skanlarƒ± y√ºkl…ônm…ôdi</div>`;
      }
    }

    function addLocalScanToTop({name, id, type, msg, level}){
      const time = 'Saat ' + new Date().toLocaleTimeString('az-AZ');
      const err = level === 'error';
      const warn = level === 'warning' || level === 'confirm';
      scanHistory.unshift({ name, id, type, msg, time, err, warn });
      if (scanHistory.length > 200) scanHistory.pop();
      renderScanList();
    }

    function startCountdown(){
      if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }

      const countdownEl = document.getElementById('countdown');
      const countdownText = document.getElementById('countdownText');

      countdownEl.style.display = 'block';
      countdownText.style.display = 'block';

      let seconds = COUNTDOWN_SECONDS;
      countdownEl.textContent = seconds;

      countdownInterval = setInterval(()=>{
        seconds--;
        countdownEl.textContent = seconds;
        if (seconds <= 0){
          clearInterval(countdownInterval);
          countdownInterval = null;
          hideResult();
        }
      }, 1000);
    }

    function showResult({resultType, name, id, type, statusText, mode='auto', confirmToken=null}){
      document.getElementById('countdown').textContent = COUNTDOWN_SECONDS;

      const overlay = document.getElementById('resultOverlay');
      const card = document.getElementById('resultCard');
      const icon = document.getElementById('resultIcon');
      const title = document.getElementById('resultTitle');

      document.getElementById('detailName').textContent = name || '-';
      document.getElementById('detailId').textContent = id || '-';
      document.getElementById('detailTicket').textContent = type || '-';
      document.getElementById('detailStatus').textContent = statusText || '-';

      card.className = 'result-card result-' + resultType;

      const confirmBtn = document.getElementById('confirmBtn');
      const closeBtn = document.getElementById('closeBtn');

      pendingConfirmToken = confirmToken || null;

      confirmBtn.style.display = 'none';
      confirmBtn.disabled = false;
      confirmBtn.textContent = '‚úÖ T…ôsdiq et';

      closeBtn.disabled = false;
      closeBtn.style.opacity = '1';
      closeBtn.style.cursor = 'pointer';

      document.getElementById('countdown').style.display='none';
      document.getElementById('countdownText').style.display='none';
      if (countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }

      if (resultType === 'success'){
        icon.textContent='‚úì'; title.textContent='T…ôsdiql…ôndi';
        closeBtn.disabled = true; closeBtn.style.opacity = '.6'; closeBtn.style.cursor = 'not-allowed';
        if (mode === 'auto') startCountdown();
      } else if (resultType === 'warning'){
        icon.textContent='‚ö†'; title.textContent='X…ôb…ôrdarlƒ±q';
        closeBtn.disabled = true; closeBtn.style.opacity = '.6'; closeBtn.style.cursor = 'not-allowed';
        if (mode === 'auto') startCountdown();
      } else if (resultType === 'confirm'){
        icon.textContent='?'; title.textContent='T…ôsdiq t…ôl…ôb olunur';
        if (mode === 'confirm') confirmBtn.style.display = 'block';
      } else {
        icon.textContent='‚úï'; title.textContent='X…ôta';
        closeBtn.disabled = true; closeBtn.style.opacity = '.6'; closeBtn.style.cursor = 'not-allowed';
        if (mode === 'auto') startCountdown();
      }

      overlay.style.display='flex';
    }

    function hideResult(){
      document.getElementById('resultOverlay').style.display='none';
      isProcessing = false;

      pendingConfirmToken = null;
      pendingConfirmQrData = null;
      pendingConfirmMeta = null;

      document.getElementById('countdown').style.display='none';
      document.getElementById('countdownText').style.display='none';
      if (countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }

      updateStatus('waiting','QR kod g√∂zl…ônilir...');
    }

    function shouldDropDuplicate(qrText){
      const now = Date.now();
      if (qrText === lastQrText && (now - lastQrAt) < LAST_QR_COOLDOWN_MS) return true;
      lastQrText = qrText;
      lastQrAt = now;
      return false;
    }

    async function handleScan(qrData){
      if (shouldDropDuplicate(qrData)) return;
      if (isProcessing) return;
      isProcessing = true;

      updateStatus('scanning','Yoxlanƒ±lƒ±r...');

      try{
        const res = await fetchJSONP(
          `${SHEET_API_URL}?action=scanTicket&qrData=${encodeURIComponent(qrData)}`,
          { timeoutMs: 12000, retry: 1 }
        );

        const name = res.data?.adSoyad || '-';
        const id = res.data?.empId || '-';
        const ticketType = res.data?.ticketType || (isDryQR(qrData) ? 'Quru Talon' : '-');
        const isDry = isDryQR(qrData) || String(ticketType).toLowerCase().includes('quru');

        if (isDry){
          const c = getDryCount(qrData);

          if (c >= 2){
            updateStatus('warning','T…ôkrar c…ôhd');
            addLocalScanToTop({name, id, type:'Quru Talon', msg:'T…ôkrar c…ôhd', level:'warning'});
            showResult({resultType:'warning', name, id, type:'Quru Talon', statusText:'T…ôkrar c…ôhd', mode:'auto'});
            return;
          }

          if (c === 1){
            const token =
              res.token ||
              res.confirmToken ||
              res.data?.token ||
              res.data?.confirmToken ||
              null;

            pendingConfirmQrData = qrData;
            pendingConfirmMeta = { name, id, type:'Quru Talon' };
            pendingConfirmToken = token;

            updateStatus('warning','T…ôsdiq');
            addLocalScanToTop({name, id, type:'Quru Talon', msg:'T…ôsdiq et (2-ci scan)', level:'confirm'});

            showResult({
              resultType:'confirm',
              name, id,
              type:'Quru Talon',
              statusText:'‚úÖ T…ôsdiq et d√ºym…ôsin…ô basƒ±n',
              mode:'confirm',
              confirmToken: token
            });
            return;
          }

          setDryCount(qrData, 1);
        }

        if (res.status === 'success'){
          updateStatus('success', res.message || 'T…ôsdiql…ôndi');
          addLocalScanToTop({name, id, type: ticketType, msg: res.message || 'T…ôsdiql…ôndi', level:'success'});
          showResult({resultType:'success', name, id, type: ticketType, statusText: res.message || 'T…ôsdiql…ôndi', mode:'auto'});
          loadTodayScans(); // c…ôdv…ôll…ô baƒülƒ± yenil…ô
          return;
        }

        if (res.status === 'warning'){
          updateStatus('warning', res.message || 'X…ôb…ôrdarlƒ±q');
          addLocalScanToTop({name, id, type: ticketType, msg: res.message || 'X…ôb…ôrdarlƒ±q', level:'warning'});
          showResult({resultType:'warning', name, id, type: ticketType, statusText: res.message || 'X…ôb…ôrdarlƒ±q', mode:'auto'});
          loadTodayScans();
          return;
        }

        if (res.status === 'confirm'){
          const token =
            res.token ||
            res.confirmToken ||
            res.data?.token ||
            res.data?.confirmToken ||
            null;

          pendingConfirmQrData = qrData;
          pendingConfirmMeta = { name, id, type: ticketType };
          pendingConfirmToken = token;

          addLocalScanToTop({name, id, type: ticketType, msg: res.message || 'T…ôsdiq t…ôl…ôb olunur', level:'confirm'});
          showResult({
            resultType:'confirm',
            name, id, type: ticketType,
            statusText: res.message || 'T…ôsdiq t…ôl…ôb olunur',
            mode:'confirm',
            confirmToken: token
          });
          return;
        }

        updateStatus('error', res.message || 'X…ôta');
        addLocalScanToTop({name:'X…ôta', id:'-', type:'-', msg: res.message || 'X…ôta', level:'error'});
        showResult({resultType:'error', name:'X…ôta', id:'-', type:'-', statusText: res.message || 'X…ôta', mode:'auto'});

      }catch(e){
        updateStatus('error','Server…ô qo≈üulmadƒ±');
        addLocalScanToTop({name:'Baƒülantƒ± x…ôtasƒ±', id:'-', type:'-', msg:'Server…ô qo≈üulmadƒ±', level:'error'});
        showResult({resultType:'error', name:'Baƒülantƒ± x…ôtasƒ±', id:'-', type:'-', statusText:'Server…ô qo≈üulmadƒ±', mode:'auto'});
      }
    }

    document.getElementById('confirmBtn').onclick = async () => {
      const btn = document.getElementById('confirmBtn');
      if (!pendingConfirmQrData) return;

      btn.disabled = true;
      btn.textContent = 'G√∂nd…ôrilir...';

      const meta = pendingConfirmMeta || {name:'-', id:'-', type:'Quru Talon'};
      const qrData = pendingConfirmQrData;
      const token = pendingConfirmToken || '';

      try{
        const url =
          `${SHEET_API_URL}?action=confirmDrySecond` +
          `&token=${encodeURIComponent(token)}` +
          `&confirmToken=${encodeURIComponent(token)}` +
          `&qrData=${encodeURIComponent(qrData)}`;

        const res = await fetchJSONP(url, { timeoutMs: 12000, retry: 1 });

        if (res && (res.status === 'error' || res.status === 'failed')){
          updateStatus('error', res.message || 'T…ôsdiq alƒ±nmadƒ±');
          addLocalScanToTop({name: meta.name, id: meta.id, type: meta.type, msg: res.message || 'T…ôsdiq alƒ±nmadƒ±', level:'error'});
          showResult({resultType:'error', name: meta.name, id: meta.id, type: meta.type, statusText: res.message || 'T…ôsdiq alƒ±nmadƒ±', mode:'auto'});
          return;
        }

        setDryCount(qrData, 2);

        updateStatus('success','T…ôsdiq');
        addLocalScanToTop({
          name: res?.data?.adSoyad || meta.name,
          id: res?.data?.empId || meta.id,
          type: res?.data?.ticketType || meta.type,
          msg: res?.message || 'T…ôsdiq',
          level:'success'
        });

        showResult({
          resultType:'success',
          name: res?.data?.adSoyad || meta.name,
          id: res?.data?.empId || meta.id,
          type: res?.data?.ticketType || meta.type,
          statusText: res?.message || 'T…ôsdiq ‚úÖ',
          mode:'auto'
        });

        loadTodayScans();
      }catch(e){
        updateStatus('error','T…ôsdiq g√∂nd…ôrilm…ôdi');
        addLocalScanToTop({name: meta.name, id: meta.id, type: meta.type, msg:'T…ôsdiq g√∂nd…ôrilm…ôdi', level:'error'});
        showResult({resultType:'error', name: meta.name, id: meta.id, type: meta.type, statusText:'T…ôsdiq g√∂nd…ôrilm…ôdi', mode:'auto'});
      }finally{
        btn.textContent = 'G√∂nd…ôrildi ‚úÖ';
      }
    };

    document.getElementById('closeBtn').onclick = () => {
      const closeBtn = document.getElementById('closeBtn');
      if (closeBtn.disabled) return;

      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      hideResult();
    };

    function startCamera(){
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode:"environment" },
        { fps: 12, qrbox:{ width:250, height:250 }, disableFlip:true },
        (text)=>{ if (!isProcessing) handleScan(text); },
        ()=>{}
      ).catch(err=>{
        updateStatus('error','Kamera a√ßƒ±lmadƒ±!');
        console.error(err);
      });
    }

    document.getElementById('searchInput').addEventListener('input', () => renderScanList());

    window.onload = async () => {
      await loadTodayScans();
      startCamera();
      setInterval(loadTodayScans, 30000);
    };

    window.onbeforeunload = ()=>{
      try{ if (html5QrCode) html5QrCode.stop(); }catch(e){}
      if (countdownInterval) clearInterval(countdownInterval);
    };
  </script>
</body>
</html>
