<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GHG Yem…ôk Skaner</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;min-height:100vh}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px;text-align:center}
    .header h1{font-size:1.3em}
    .container{max-width:600px;margin:0 auto;padding:15px}
    .scanner-box{background:#fff;border-radius:20px;padding:15px;margin-bottom:15px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    #reader{width:100%;border-radius:16px;overflow:hidden}
    .status{text-align:center;padding:12px;margin-top:10px;border-radius:12px;font-weight:600;font-size:.95em}
    .status-waiting{background:#fff3e0;color:#e65100}
    .status-scanning{background:#e3f2fd;color:#1565c0}
    .status-success{background:#e8f5e9;color:#2e7d32}
    .status-warning{background:#fff3e0;color:#f57c00}
    .status-error{background:#ffebee;color:#c62828}

    .result-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;justify-content:center;align-items:center;padding:20px}
    .result-card{background:#fff;border-radius:24px;padding:26px;width:100%;max-width:420px;text-align:center}
    .result-icon{width:90px;height:90px;border-radius:50%;margin:0 auto 18px;display:flex;align-items:center;justify-content:center;font-size:46px}
    .result-success .result-icon{background:#e8f5e9;color:#4caf50}
    .result-warning .result-icon{background:#fff3e0;color:#ff9800}
    .result-error .result-icon{background:#ffebee;color:#f44336}
    .result-title{font-size:1.3em;font-weight:800;margin-bottom:14px}
    .result-details{background:#f5f5f5;border-radius:16px;padding:16px;margin-bottom:14px;text-align:left}
    .detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e0e0e0}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:#666;font-size:.9em}
    .detail-value{color:#333;font-weight:700;font-size:.95em}

    .btn{border:none;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer;width:100%}
    .btn-confirm{background:#4caf50;color:#fff;margin-top:10px}
    .btn-close{background:#e0e0e0;color:#111;margin-top:10px}

    .countdown{font-size:2.2em;font-weight:800;color:#667eea;margin-top:10px}
    .countdown-text{color:#999;font-size:.9em;margin-top:5px}

    .last-scan{background:#fff;border-radius:20px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .last-scan h2{font-size:1.1em;color:#333;margin-bottom:15px}
    .scan-item{display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee}
    .scan-item:last-child{border-bottom:none}
    .scan-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;margin-right:12px;flex-shrink:0}
    .scan-icon.ok{background:#e8f5e9;color:#4caf50}
    .scan-icon.warn{background:#fff3e0;color:#ff9800}
    .scan-icon.err{background:#ffebee;color:#f44336}
    .scan-info{flex:1;min-width:0}
    .scan-name{font-weight:700;color:#333;font-size:.95em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .scan-detail{color:#666;font-size:.8em;margin-top:2px}
    .scan-time{color:#999;font-size:.75em;margin-top:2px}
  </style>
</head>
<body>
  <div class="header"><h1>üçΩÔ∏è GHG Yem…ôk Skaner</h1></div>

  <div class="container">
    <div class="scanner-box">
      <div id="reader"></div>
      <div class="status status-waiting" id="status">QR kod g√∂zl…ônilir...</div>
    </div>

    <div class="last-scan">
      <h2>üìã Son skan edil…ônl…ôr</h2>
      <div id="scanList">
        <div style="text-align:center;color:#999;padding:20px;">H…ôl…ô he√ß bir skan edilm…ôyib</div>
      </div>
    </div>
  </div>

  <div class="result-overlay" id="resultOverlay">
    <div class="result-card" id="resultCard">
      <div class="result-icon" id="resultIcon">‚úì</div>
      <div class="result-title" id="resultTitle">T…ôsdiql…ôndi</div>

      <div class="result-details">
        <div class="detail-row"><span class="detail-label">∆èm…ôkda≈ü:</span><span class="detail-value" id="detailName">-</span></div>
        <div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value" id="detailId">-</span></div>
        <div class="detail-row"><span class="detail-label">Talon:</span><span class="detail-value" id="detailTicket">-</span></div>
        <div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value" id="detailStatus">-</span></div>
      </div>

      <button class="btn btn-confirm" id="confirmBtn" style="display:none;">‚úÖ T…ôsdiq et</button>
      <button class="btn btn-close" id="closeBtn">Baƒüla</button>

      <div class="countdown" id="countdown" style="display:none;">5</div>
      <div class="countdown-text" id="countdownText" style="display:none;">saniy…ô sonra skaner…ô qayƒ±dƒ±lƒ±r</div>
    </div>
  </div>

  <script>
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxtHn5BnqLDYJj3HYe_0LZEQtX5B5AjLUUapjUmlj3jn1sCGsZmAIW817qfr9lQlh-i/exec';

    const COUNTDOWN_SECONDS = 5; // ‚úÖ burdan idar…ô et

    let isProcessing = false;
    let scanHistory = [];
    let html5QrCode = null;
    let countdownInterval = null;
    let pendingConfirmToken = null;

    const SCAN_RETURN_SECONDS = 5;

    function fetchJSONP(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        const script = document.createElement('script');

        window[cb] = (data) => {
          delete window[cb];
          script.remove();
          resolve(data);
        };

        const t = setTimeout(() => {
          if (window[cb]) delete window[cb];
          script.remove();
          reject(new Error('Timeout'));
        }, 12000);

        script.onerror = () => { clearTimeout(t); reject(new Error('Load error')); };
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.head.appendChild(script);
      });
    }

    function updateStatus(type, text){
      const s = document.getElementById('status');
      s.className = 'status status-' + type;
      s.textContent = text;
    }

    function addScan(item){
      const time = new Date().toLocaleTimeString('az-AZ');
      scanHistory.unshift({...item, time});
      if (scanHistory.length > 10) scanHistory.pop();

      const list = document.getElementById('scanList');
      list.innerHTML = scanHistory.map(scan=>{
        let icon='‚úì', cls='ok';
        if (scan.err) { icon='‚úï'; cls='err'; }
        else if (scan.warn) { icon='‚ö†'; cls='warn'; }

        return `
          <div class="scan-item">
            <div class="scan-icon ${cls}">${icon}</div>
            <div class="scan-info">
              <div class="scan-name">${scan.name}</div>
              <div class="scan-detail">${scan.id} ${scan.type ? '| ' + scan.type : ''} | ${scan.msg}</div>
              <div class="scan-time">${scan.time}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function startCountdown(){
      // ‚úÖ k√∂hn…ô interval qalmasƒ±n
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }

      const countdownEl = document.getElementById('countdown');
      const countdownText = document.getElementById('countdownText');
      countdownEl.style.display = 'block';
      countdownText.style.display = 'block';

 codex/skan-et-5-saniy
      let seconds = SCAN_RETURN_SECONDS;

      let seconds = COUNTDOWN_SECONDS;
 main
      countdownEl.textContent = seconds;

      countdownInterval = setInterval(()=>{
        seconds--;
        countdownEl.textContent = seconds;
        if (seconds <= 0){
          clearInterval(countdownInterval);
          countdownInterval = null;
          hideResult();
        }
      },1000);
    }

    function showResult({resultType, name, id, type, statusText, confirmToken}){
      // ‚úÖ overlay a√ßƒ±lan kimi countdown text-i h…ômi≈ü…ô 5 et
      document.getElementById('countdown').textContent = COUNTDOWN_SECONDS;

      const overlay = document.getElementById('resultOverlay');
      const card = document.getElementById('resultCard');
      const icon = document.getElementById('resultIcon');
      const title = document.getElementById('resultTitle');

      document.getElementById('detailName').textContent = name || '-';
      document.getElementById('detailId').textContent = id || '-';
      document.getElementById('detailTicket').textContent = type || '-';
      document.getElementById('detailStatus').textContent = statusText || '-';

      card.className = 'result-card result-' + resultType;

      const confirmBtn = document.getElementById('confirmBtn');
      const closeBtn = document.getElementById('closeBtn');
      pendingConfirmToken = confirmToken || null;

      closeBtn.disabled = false;
      closeBtn.style.opacity = '1';
      closeBtn.style.cursor = 'pointer';

      if (resultType === 'success'){
        icon.textContent='‚úì'; title.textContent='T…ôsdiql…ôndi';
        confirmBtn.style.display='none';
        closeBtn.disabled = true;
        closeBtn.style.opacity = '.6';
        closeBtn.style.cursor = 'not-allowed';
        startCountdown();
      } else if (resultType === 'warning'){
        icon.textContent='‚ö†'; title.textContent='X…ôb…ôrdarlƒ±q';
        confirmBtn.style.display='none';
        closeBtn.disabled = true;
        closeBtn.style.opacity = '.6';
        closeBtn.style.cursor = 'not-allowed';
        startCountdown();
      } else if (resultType === 'confirm'){
        icon.textContent='?'; title.textContent='T…ôsdiq';
        confirmBtn.style.display='block';
        closeBtn.disabled = false;
        closeBtn.style.opacity = '1';
        closeBtn.style.cursor = 'pointer';
        document.getElementById('countdown').style.display='none';
        document.getElementById('countdownText').style.display='none';
        // confirm modunda interval i≈ül…ôm…ôsin
        if (countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }
      } else {
        icon.textContent='‚úï'; title.textContent='X…ôta';
        confirmBtn.style.display='none';
        closeBtn.disabled = true;
        closeBtn.style.opacity = '.6';
        closeBtn.style.cursor = 'not-allowed';
        startCountdown();
      }

      overlay.style.display='flex';
    }

    function hideResult(){
      document.getElementById('resultOverlay').style.display='none';
      isProcessing = false;
      pendingConfirmToken = null;
      const closeBtn = document.getElementById('closeBtn');
      closeBtn.disabled = false;
      closeBtn.style.opacity = '1';
      closeBtn.style.cursor = 'pointer';
      updateStatus('waiting','QR kod g√∂zl…ônilir...');
    }

    async function handleScan(qrData){
      if (isProcessing) return;
      isProcessing = true;
      updateStatus('scanning','Yoxlanƒ±lƒ±r...');

      try{
        const res = await fetchJSONP(`${SHEET_API_URL}?action=scanTicket&qrData=${encodeURIComponent(qrData)}`);

        if (res.status === 'success'){
          addScan({name: res.data.adSoyad, id: res.data.empId, type: res.data.ticketType, msg: res.message, warn:false, err:false});
          showResult({resultType:'success', name:res.data.adSoyad, id:res.data.empId, type:res.data.ticketType, statusText:res.message});
          return;
        }

        if (res.status === 'warning'){
          addScan({name: res.data.adSoyad, id: res.data.empId, type: res.data.ticketType, msg: res.message, warn:true, err:false});
          showResult({resultType:'warning', name:res.data.adSoyad, id:res.data.empId, type:res.data.ticketType, statusText:res.message});
          return;
        }

        if (res.status === 'confirm'){
          addScan({name: res.data.adSoyad, id: res.data.empId, type: res.data.ticketType, msg: res.message, warn:true, err:false});
          showResult({resultType:'confirm', name:res.data.adSoyad, id:res.data.empId, type:res.data.ticketType, statusText:res.message, confirmToken: res.token});
          return;
        }

        addScan({name:'X…ôta', id:'-', msg: res.message || 'X…ôta', err:true});
        showResult({resultType:'error', name:'X…ôta', id:'-', type:'-', statusText:res.message || 'X…ôta'});
      }catch(e){
        addScan({name:'Baƒülantƒ± x…ôtasƒ±', id:'-', msg:'Server…ô qo≈üulmadƒ±', err:true});
        showResult({resultType:'error', name:'Baƒülantƒ± x…ôtasƒ±', id:'-', type:'-', statusText:'Server…ô qo≈üulmadƒ±'});
      }
    }

    document.getElementById('confirmBtn').onclick = async () => {
      if (!pendingConfirmToken) return;
      try{
        const res = await fetchJSONP(`${SHEET_API_URL}?action=confirmDrySecond&token=${encodeURIComponent(pendingConfirmToken)}`);
        addScan({name: res.data?.adSoyad || '-', id: res.data?.empId || '-', type: res.data?.ticketType || '-', msg: res.message || 'T…ôkrar c…ôhd', warn:true, err:false});
        showResult({resultType:'warning', name:res.data?.adSoyad || '-', id:res.data?.empId || '-', type:res.data?.ticketType || '-', statusText:res.message || 'T…ôkrar c…ôhd'});
      }catch(e){
        showResult({resultType:'error', name:'X…ôta', id:'-', type:'-', statusText:'T…ôsdiq g√∂nd…ôrilm…ôdi'});
      }
    };

    document.getElementById('closeBtn').onclick = () => {
 codex/skan-et-5-saniy
      const closeBtn = document.getElementById('closeBtn');
      if (closeBtn.disabled) return;
      if (countdownInterval) clearInterval(countdownInterval);

      if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
 main
      hideResult();
    };

    function startCamera(){
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode:"environment" },
        { fps:10, qrbox:{ width:250, height:250 } },
        (text)=>{ if (!isProcessing) handleScan(text); },
        ()=>{}
      ).catch(err=>{
        updateStatus('error','Kamera a√ßƒ±lmadƒ±!');
        console.error(err);
      });
    }

    window.onload = startCamera;
    window.onbeforeunload = ()=>{ if (html5QrCode) html5QrCode.stop(); if (countdownInterval) clearInterval(countdownInterval); };
  </script>
</body>
</html>
