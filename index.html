<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHG Yem…ôk Skaner</title>
    
    <!-- Html5Qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.3em;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
        }

        /* Skaner b√∂lm…ôsi */
        .scanner-box {
            background: white;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #reader {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
        }

        .status {
            text-align: center;
            padding: 12px;
            margin-top: 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .status-waiting { background: #fff3e0; color: #e65100; }
        .status-scanning { background: #e3f2fd; color: #1565c0; }
        .status-success { background: #e8f5e9; color: #2e7d32; }
        .status-warning { background: #fff3e0; color: #f57c00; }
        .status-error { background: #ffebee; color: #c62828; }

        /* 10 saniy…ôlik n…ôtic…ô ekranƒ± */
        .result-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .result-card {
            background: white;
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .result-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
        }

        .result-success .result-icon { background: #e8f5e9; color: #4caf50; }
        .result-warning .result-icon { background: #fff3e0; color: #ff9800; }
        .result-error .result-icon { background: #ffebee; color: #f44336; }

        .result-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .result-success .result-title { color: #2e7d32; }
        .result-warning .result-title { color: #f57c00; }
        .result-error .result-title { color: #c62828; }

        .result-details {
            background: #f5f5f5;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-row:last-child { border-bottom: none; }

        .detail-label {
            color: #666;
            font-size: 0.9em;
        }

        .detail-value {
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        .countdown {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-top: 15px;
        }

        .countdown-text {
            color: #999;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Son skanlar siyahƒ±sƒ± */
        .last-scan {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .last-scan h2 {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
        }

        .scan-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .scan-item:last-child { border-bottom: none; }

        .scan-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .scan-icon.ok { background: #e8f5e9; color: #4caf50; }
        .scan-icon.warn { background: #fff3e0; color: #ff9800; }
        .scan-icon.err { background: #ffebee; color: #f44336; }

        .scan-info { flex: 1; min-width: 0; }

        .scan-name {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scan-detail {
            color: #666;
            font-size: 0.8em;
            margin-top: 2px;
        }

        .scan-time {
            color: #999;
            font-size: 0.75em;
            margin-top: 2px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>üçΩÔ∏è GHG Yem…ôk Skaner</h1>
    </div>

    <div class="container">
        <div class="scanner-box">
            <div id="reader"></div>
            <div class="status status-waiting" id="status">
                QR kod g√∂zl…ônilir...
            </div>
        </div>

        <div class="last-scan">
            <h2>üìã Son skan edil…ônl…ôr</h2>
            <div id="scanList">
                <div style="text-align: center; color: #999; padding: 20px;">
                    H…ôl…ô he√ß bir skan edilm…ôyib
                </div>
            </div>
        </div>
    </div>

    <!-- 10 saniy…ôlik n…ôtic…ô ekranƒ± -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-card" id="resultCard">
            <div class="result-icon" id="resultIcon">‚úì</div>
            <div class="result-title" id="resultTitle">T…ôsdiql…ôndi</div>
            
            <div class="result-details" id="resultDetails">
                <div class="detail-row">
                    <span class="detail-label">∆èm…ôkda≈ü:</span>
                    <span class="detail-value" id="detailName">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">ID:</span>
                    <span class="detail-value" id="detailId">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Talon:</span>
                    <span class="detail-value" id="detailTicket">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value" id="detailStatus">-</span>
                </div>
            </div>
            
            <div class="countdown" id="countdown">10</div>
            <div class="countdown-text">saniy…ô sonra skaner…ô qayƒ±dƒ±lƒ±r</div>
        </div>
    </div>

    <script>
        // WEB APP URL-Nƒ∞Zƒ∞ BURAYA YAZIN (BO≈ûLUQ OLMASIN!)
        const SHEET_API_URL = 'var EMPLOYEES_FILE_ID = '1tJ_U_EtSF7YCjGahjKYn-w_TDgCuaPZL_tGMJ0ZFOdM';
var SCANNER_FILE_ID = '-1RAGc0WsyXO6A7fjyad_nJDiLqM22eYREccJdjie3TMw';

function doGet(e) {
  var callback = getParam_(e, 'callback');
  try {
    var action = getParam_(e, 'action');
    var result;

    if (action === 'login') {
      result = handleLogin_(e);
    } else if (action === 'scanTicket') {
      result = handleScan_(getParam_(e, 'qrData'));
    } else if (action === 'checkScanStatus') {
      result = handleCheckScanStatus_(e);
    } else if (action === 'submitRating') {
      result = handleSubmitRating_(e);
    } else {
      result = { status: 'error', message: 'Nam…ôlum …ôm…ôliyyat' };
    }

    return sendJSONP_(result, callback);
  } catch (err) {
    return sendJSONP_({ status: 'error', message: String(err) }, callback);
  }
}

function doPost(e) {
  return doGet(e);
}

function handleLogin_(e) {
  var id = getParam_(e, 'id') || getParam_(e, 'employeeId');
  var pass = getParam_(e, 'pass') || getParam_(e, 'password');

  if (!id || !pass) {
    return { status: 'error', message: 'ID v…ô parol t…ôl…ôb olunur' };
  }

  var sheet = getEmployeesSheet_();
  var data = sheet.getDataRange().getValues();
  if (!data || data.length < 2) {
    return { status: 'not_found', message: 'ƒ∞stifad…ô√ßi tapƒ±lmadƒ±' };
  }

  var cols = detectColumns_(data[0]);
  if (cols.id < 0) {
    return { status: 'error', message: 'ID s√ºtunu tapƒ±lmadƒ±' };
  }

  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    if (toText_(row[cols.id]) !== id) {
      continue;
    }

    if (cols.pass >= 0 && toText_(row[cols.pass]) !== pass) {
      return { status: 'invalid_pass', message: 'Parol yanlƒ±≈üdƒ±r' };
    }

    var fullName = cols.name >= 0 ? toText_(row[cols.name]) : '';
    var firstName = cols.firstName >= 0 ? toText_(row[cols.firstName]) : '';
    var lastName = cols.lastName >= 0 ? toText_(row[cols.lastName]) : '';
    var fatherName = cols.fatherName >= 0 ? toText_(row[cols.fatherName]) : '';

    return {
      status: 'success',
      employee: {
        id: id,
        fullName: buildFullName_(fullName, firstName, lastName, fatherName),
        firstName: firstName,
        lastName: lastName,
        fatherName: fatherName
      }
    };
  }

  return { status: 'not_found', message: 'ƒ∞stifad…ô√ßi tapƒ±lmadƒ±' };
}

function handleSubmitRating_(e) {
  var employeeId = getParam_(e, 'employeeId') || getParam_(e, 'id');
  var fullName = getParam_(e, 'fullName');
  var ratingText = getParam_(e, 'ratingText') || getParam_(e, 'reason');
  var ratingStars = Number(getParam_(e, 'ratingStars') || getParam_(e, 'rating'));

  if (!employeeId) {
    return { status: 'error', message: 'employeeId bo≈üdur' };
  }
  if (!ratingText) {
    return { status: 'error', message: 'S…ôb…ôb bo≈üdur' };
  }
  if (!ratingStars || ratingStars < 1 || ratingStars > 5) {
    return { status: 'error', message: 'Ulduz 1-5 arasƒ± olmalƒ±dƒ±r' };
  }

  var employeesSheet = getEmployeesSheet_();
  var employeeData = findEmployeeById_(employeesSheet, employeeId);
  var displayName = fullName || employeeData.displayName;

  var ratingSheet = getOrCreateRatingSheet_(employeesSheet.getParent());
  ensureRatingHeaders_(ratingSheet);

  var headers = ratingSheet.getRange(1, 1, 1, Math.max(1, ratingSheet.getLastColumn())).getValues()[0];
  var map = headerMap_(headers);
  var row = ratingSheet.getLastRow() + 1;

  writeByAliases_(ratingSheet, row, map, ['id', 'iÃád', '…ôm…ôkda≈ü id', 'employee id'], employeeId);
  writeByAliases_(ratingSheet, row, map, ['ad v…ô soyad', 'ad soyad', 'full name'], displayName);
  writeByAliases_(ratingSheet, row, map, ['ulduzla qiym…ôtl…ôndirm…ô', 'ulduzla qiymetlendirme', 'ulduz'], ratingStars);
  writeByAliases_(ratingSheet, row, map, ['yem…ôk qiym…ôtl…ôndirm…ô', 'yemek qiymetlendirme', 'qiym…ôtl…ôndirm…ô m…ôtni'], ratingText);

  return { status: 'success', message: 'Qiym…ôtl…ôndirm…ô …ôlav…ô edildi' };
}

function handleScan_(qrData) {
  if (!qrData) {
    return { status: 'error', message: 'QR data bo≈üdur' };
  }

  var parsed = parseQR_(qrData);
  if (!parsed) {
    return { status: 'error', message: 'Yanlƒ±≈ü QR formatƒ±' };
  }

  if (parsed.dateKey !== todayDateKey_()) {
    return {
      status: 'error',
      speak: true,
      message: 'Bu QR bu g√ºn…ô aid deyil'
    };
  }

  var scannerSheet = getScannerSheet_();
  var rows = scannerSheet.getDataRange().getValues();
  var duplicate = false;

  for (var i = 1; i < rows.length; i++) {
    if (
      toText_(rows[i][2]) === parsed.dateKey &&
      toText_(rows[i][3]) === parsed.empId &&
      toText_(rows[i][6]) === parsed.typeId &&
      toText_(rows[i][8]) === 'T…ôsdiql…ôndi'
    ) {
      duplicate = true;
      break;
    }
  }

  var now = new Date();
  var statusText = duplicate ? 'T…ôkrar c…ôhd' : 'T…ôsdiql…ôndi';
  var employee = findEmployeeById_(getEmployeesSheet_(), parsed.empId);

  scannerSheet.appendRow([
    Utilities.formatDate(now, 'Asia/Baku', 'dd.MM.yyyy'),
    Utilities.formatDate(now, 'Asia/Baku', 'HH:mm:ss'),
    parsed.dateKey,
    parsed.empId,
    employee.displayName || 'Nam…ôlum …ôm…ôkda≈ü',
    ticketTypeName_(parsed.typeCode),
    parsed.typeId,
    qrData,
    statusText
  ]);

  if (duplicate) {
    return { status: 'warning', message: 'T…ôkrar c…ôhd' };
  }

  return { status: 'success', message: 'T…ôsdiql…ôndi' };
}

function handleCheckScanStatus_(e) {
  var empId = getParam_(e, 'id');
  var ticketType = getParam_(e, 'ticketType');
  var dateKey = getParam_(e, 'date') || todayDateKey_();

  if (!empId || !ticketType) {
    return { status: 'error', used: false, message: 'Parametrl…ôr natamamdƒ±r' };
  }

  var scannerSheet = getScannerSheet_();
  var rows = scannerSheet.getDataRange().getValues();

  for (var i = 1; i < rows.length; i++) {
    if (
      toText_(rows[i][2]) === dateKey &&
      toText_(rows[i][3]) === empId &&
      toText_(rows[i][6]) === ticketType &&
      toText_(rows[i][8]) === 'T…ôsdiql…ôndi'
    ) {
      return { status: 'success', used: true };
    }
  }

  return { status: 'success', used: false };
}

function parseQR_(qrData) {
  var parts = String(qrData || '').split('|');
  if (parts.length < 6 || parts[0] !== 'GHG') {
    return null;
  }

  return {
    empId: toText_(parts[1]),
    typeCode: toText_(parts[2]),
    dateKey: toText_(parts[3]),
    hash: toText_(parts[4]),
    typeId: toText_(parts[5])
  };
}

function getEmployeesSpreadsheet_() {
  return openSpreadsheetById_(EMPLOYEES_FILE_ID, 'Employees');
}

function getScannerSpreadsheet_() {
  return openSpreadsheetById_(SCANNER_FILE_ID, 'Scanner');
}

function openSpreadsheetById_(sheetId, label) {
  var id = toText_(sheetId);
  if (!id) {
    throw new Error(label + ' fayl ID-si t…ôyin edilm…ôyib');
  }

  try {
    return SpreadsheetApp.openById(id);
  } catch (e) {
    throw new Error(label + ' faylƒ± tapƒ±lmadƒ± v…ô ya giri≈ü icaz…ôsi yoxdur (ID: ' + id + ')');
  }
}

function getEmployeesSheet_() {
  var preferredSheets = ['Cadvel1', 'C…ôdv…ôl1', 'Employees', 'Employee'];
  var candidates = [getEmployeesSpreadsheet_()];

  // B…ôzi qura≈üdƒ±rmalarda employee c…ôdv…ôli scanner faylƒ±nda saxlanƒ±lƒ±r.
  if (toText_(SCANNER_FILE_ID) && SCANNER_FILE_ID !== EMPLOYEES_FILE_ID) {
    try {
      candidates.push(getScannerSpreadsheet_());
    } catch (e) {
      // scanner faylƒ± a√ßƒ±lmasa bel…ô …ôsas employee faylƒ± il…ô davam et.
    }
  }

  for (var i = 0; i < candidates.length; i++) {
    var sheet = findSheetByNames_(candidates[i], preferredSheets);
    if (sheet) {
      return sheet;
    }
  }

  throw new Error('Employees c…ôdv…ôli tapƒ±lmadƒ± (Cadvel1/C…ôdv…ôl1)');
}

function getOrCreateRatingSheet_(ss) {
  var sheet = ss.getSheetByName('Yem…ôk qiym…ôtl…ôndirm…ôsi') || ss.getSheetByName('Yemek qiymetlendirmesi');
  if (!sheet) {
    sheet = ss.insertSheet('Yem…ôk qiym…ôtl…ôndirm…ôsi');
  }
  return sheet;
}

function getScannerSheet_() {
  var ss = getScannerSpreadsheet_();
  var sheet = ss.getSheetByName('Scanner');
  if (!sheet) {
    sheet = ss.insertSheet('Scanner');
    sheet.appendRow(['Tarix', 'Saat', 'DateKey', '∆èm…ôkda≈ü ID', 'Ad Soyad Ata adƒ±', 'Talon N√∂v√º', 'TicketTypeId', 'Talon ID', 'Status']);
  }
  return sheet;
}

function findSheetByNames_(ss, names) {
  if (!ss) return null;

  for (var i = 0; i < names.length; i++) {
    var byName = ss.getSheetByName(names[i]);
    if (byName) {
      return byName;
    }
  }

  return null;
}

function ensureRatingHeaders_(sheet) {
  var required = ['ƒ∞D', 'Ad v…ô Soyad', 'Ulduzla qiym…ôtl…ôndirm…ô', 'Yem…ôk qiym…ôtl…ôndirm…ô'];

  if (sheet.getLastRow() === 0) {
    sheet.appendRow(required);
    return;
  }

  var headers = sheet.getRange(1, 1, 1, Math.max(1, sheet.getLastColumn())).getValues()[0];
  var normalized = [];
  for (var i = 0; i < headers.length; i++) {
    normalized.push(normalize_(headers[i]));
  }

  for (var r = 0; r < required.length; r++) {
    var key = normalize_(required[r]);
    if (normalized.indexOf(key) === -1) {
      sheet.getRange(1, sheet.getLastColumn() + 1).setValue(required[r]);
      normalized.push(key);
    }
  }
}

function findEmployeeById_(sheet, employeeId) {
  var data = sheet.getDataRange().getValues();
  if (!data || data.length < 2) {
    return { displayName: '', fullName: '', firstName: '', lastName: '', fatherName: '' };
  }

  var cols = detectColumns_(data[0]);
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    if (cols.id < 0 || toText_(row[cols.id]) !== employeeId) {
      continue;
    }

    var fullName = cols.name >= 0 ? toText_(row[cols.name]) : '';
    var firstName = cols.firstName >= 0 ? toText_(row[cols.firstName]) : '';
    var lastName = cols.lastName >= 0 ? toText_(row[cols.lastName]) : '';
    var fatherName = cols.fatherName >= 0 ? toText_(row[cols.fatherName]) : '';

    return {
      displayName: buildFullName_(fullName, firstName, lastName, fatherName),
      fullName: fullName,
      firstName: firstName,
      lastName: lastName,
      fatherName: fatherName
    };
  }

  return { displayName: '', fullName: '', firstName: '', lastName: '', fatherName: '' };
}

function detectColumns_(headers) {
  return {
    id: findColumn_(headers, ['id', 'iÃád', '…ôm…ôkda≈ü id', 'employee id']),
    name: findColumn_(headers, ['ad v…ô soyad', 'ad soyad', 'full name']),
    firstName: findColumn_(headers, ['ad', 'first name']),
    lastName: findColumn_(headers, ['soyad', 'last name']),
    fatherName: findColumn_(headers, ['ata adƒ±', 'ata adi', 'father name']),
    pass: findColumn_(headers, ['parol', 'password'])
  };
}

function findColumn_(headers, aliases) {
  var normalizedHeaders = [];
  for (var i = 0; i < headers.length; i++) {
    normalizedHeaders.push(normalize_(headers[i]));
  }

  for (var a = 0; a < aliases.length; a++) {
    var alias = normalize_(aliases[a]);
    for (var c = 0; c < normalizedHeaders.length; c++) {
      if (normalizedHeaders[c] === alias || normalizedHeaders[c].indexOf(alias) !== -1 || alias.indexOf(normalizedHeaders[c]) !== -1) {
        return c;
      }
    }
  }
  return -1;
}

function headerMap_(headers) {
  var map = {};
  for (var i = 0; i < headers.length; i++) {
    map[normalize_(headers[i])] = i + 1;
  }
  return map;
}

function writeByAliases_(sheet, row, map, aliases, value) {
  for (var i = 0; i < aliases.length; i++) {
    var col = map[normalize_(aliases[i])];
    if (col) {
      sheet.getRange(row, col).setValue(value);
      return true;
    }
  }
  return false;
}

function buildFullName_(fullName, firstName, lastName, fatherName) {
  if (fullName) {
    return fullName;
  }

  var parts = [];
  if (firstName) parts.push(firstName);
  if (lastName) parts.push(lastName);
  if (fatherName) parts.push(fatherName + ' oƒülu');

  return parts.join(' ').trim();
}

function ticketTypeName_(code) {
  var types = {
    S: 'S…ôh…ôr Yem…ôyi',
    G: 'G√ºnorta Yem…ôyi',
    A: 'Ax≈üam Yem…ôyi',
    Q: 'Quru Talon'
  };
  return types[code] || 'Nam…ôlum';
}

function normalize_(value) {
  return String(value || '')
    .toLowerCase()
    .replace(/ƒ±/g, 'i')
    .replace(/…ô/g, 'e')
    .replace(/√∂/g, 'o')
    .replace(/√º/g, 'u')
    .replace(/≈ü/g, 's')
    .replace(/√ß/g, 'c')
    .replace(/ƒü/g, 'g')
    .trim();
}

function todayDateKey_() {
  return Utilities.formatDate(new Date(), 'Asia/Baku', 'yyyyMMdd');
}

function getParam_(e, key) {
  if (!e || !e.parameter || e.parameter[key] === undefined || e.parameter[key] === null) {
    return '';
  }
  return String(e.parameter[key]).trim();
}

function toText_(value) {
  return String(value || '').trim();
}

function sendJSONP_(payload, callback) {
  var text = JSON.stringify(payload);
  if (callback) {
    return ContentService.createTextOutput(callback + '(' + text + ')')
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return ContentService.createTextOutput(text)
    .setMimeType(ContentService.MimeType.JSON);
}
';
        
        let isProcessing = false;
        let scanHistory = [];
        let html5QrCode = null;
        let countdownInterval = null;
        let audioContext = null;

        function ensureAudioContext() {
            if (!audioContext) {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                if (!Ctx) return null;
                audioContext = new Ctx();
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(() => {});
            }

            return audioContext;
        }

        function playTone(frequency, duration, startAt, volume = 0.22) {
            const ctx = ensureAudioContext();
            if (!ctx) return;

            const oscillator = ctx.createOscillator();
            const gain = ctx.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, startAt);

            gain.gain.setValueAtTime(0, startAt);
            gain.gain.linearRampToValueAtTime(volume, startAt + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, startAt + duration);

            oscillator.connect(gain);
            gain.connect(ctx.destination);

            oscillator.start(startAt);
            oscillator.stop(startAt + duration);
        }

        function playFeedbackSound(resultType) {
            const ctx = ensureAudioContext();
            if (!ctx) return;

            const now = ctx.currentTime;

            if (resultType === 'success') {
                playTone(880, 0.18, now, 0.24);
                playTone(1175, 0.25, now + 0.2, 0.24);
            } else if (resultType === 'warning') {
                playTone(520, 0.22, now, 0.24);
                playTone(420, 0.28, now + 0.24, 0.24);
            } else {
              playTone(350, 0.5, now, 0.5);
                playTone(300, 0.45, now + 0.22, 0.5);
            }
        }

        // JSONP fetch
        function fetchJSONP(url) {
            return new Promise((resolve, reject) => {
                const cb = 'cb_' + Date.now();
                const script = document.createElement('script');
                
                window[cb] = (data) => {
                    delete window[cb];
                    script.remove();
                    resolve(data);
                };
                
                setTimeout(() => {
                    delete window[cb];
                    script.remove();
                    reject(new Error('Timeout'));
                }, 10000);
                
                script.src = url + '&callback=' + cb;
                document.head.appendChild(script);
            });
        }
        // JSONP fetch
        function fetchJSONP(url) {
            return new Promise((resolve, reject) => {
                const cb = 'cb_' + Date.now();
                const script = document.createElement('script');
                
                window[cb] = (data) => {
                    delete window[cb];
                    script.remove();
                    resolve(data);
                };
                
                setTimeout(() => {
                    delete window[cb];
                    script.remove();
                    reject(new Error('Timeout'));
                }, 10000);
                
                script.src = url + '&callback=' + cb;
                document.head.appendChild(script);
            });
        }

        // 10 saniy…ôlik n…ôtic…ô ekranƒ±nƒ± g√∂st…ôr
        function showResult(data) {
            const overlay = document.getElementById('resultOverlay');
            const card = document.getElementById('resultCard');
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const countdownEl = document.getElementById('countdown');
            
            // M…ôlumatlarƒ± doldur
            document.getElementById('detailName').textContent = data.name || '-';
            document.getElementById('detailId').textContent = data.id || '-';
            document.getElementById('detailTicket').textContent = data.type || '-';
            document.getElementById('detailStatus').textContent = data.statusText || '-';
            
            // Stil t…ôyin et
            card.className = 'result-card result-' + data.resultType;
            
            if (data.resultType === 'success') {
                icon.textContent = '‚úì';
                title.textContent = 'T…ôsdiql…ôndi';
            } else if (data.resultType === 'warning') {
                icon.textContent = '‚ö†';
                title.textContent = 'X…ôb…ôrdarlƒ±q';
            } else {
                icon.textContent = '‚úï';
                title.textContent = 'X…ôta';
            }

            playFeedbackSound(data.resultType);
            
            // Ekranƒ± g√∂st…ôr
            overlay.style.display = 'flex';
            
            // Geri sayƒ±m ba≈ülat
            let seconds = 10;
            countdownEl.textContent = seconds;
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    hideResult();
                }
            }, 1000);
            
            // Klikl…ô baƒülamaq √º√ß√ºn
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    clearInterval(countdownInterval);
                    hideResult();
                }
            };
        }

        // N…ôtic…ô ekranƒ±nƒ± gizl…ôt v…ô skaner…ô qayƒ±t
        function hideResult() {
            document.getElementById('resultOverlay').style.display = 'none';
            isProcessing = false;
            updateStatus('waiting', 'QR kod g√∂zl…ônilir...');
        }

        // Skan emalƒ±
        async function handleScan(qrData) {
            if (isProcessing) return;
            isProcessing = true;
            
            updateStatus('scanning', 'Yoxlanƒ±lƒ±r...');
            
            try {
                const result = await fetchJSONP(
                    SHEET_API_URL + '?action=scanTicket&qrData=' + encodeURIComponent(qrData)
                );
                
                console.log('N…ôtic…ô:', result);
                
                if (result.status === 'success') {
                    const data = {
                        resultType: 'success',
                        name: result.data.adSoyad,
                        id: result.data.empId,
                        type: result.data.ticketType,
                        statusText: result.message || 'T…ôsdiql…ôndi'
                    };
                    
                    addScan({
                        ok: true,
                        name: result.data.adSoyad,
                        id: result.data.empId,
                        type: result.data.ticketType,
                        msg: result.message || 'T…ôsdiql…ôndi'
                    });
                    
                    showResult(data);
                    
                } else if (result.status === 'warning') {
                    const data = {
                        resultType: 'warning',
                        name: result.data.adSoyad,
                        id: result.data.empId,
                        type: result.data.ticketType,
                        statusText: result.message || 'Artƒ±q istifad…ô edilib'
                    };
                    
                    addScan({
                        ok: false,
                        warn: true,
                        name: result.data.adSoyad,
                        id: result.data.empId,
                        type: result.data.ticketType,
                        msg: result.message || 'Artƒ±q istifad…ô edilib'
                    });
                    
                    showResult(data);
                    
                } else {
                    const data = {
                        resultType: 'error',
                        name: 'X…ôta',
                        id: '-',
                        type: '-',
                        statusText: result.message || 'Yanlƒ±≈ü QR kod'
                    };
                    
                    addScan({
                        ok: false,
                        name: 'X…ôta',
                        id: '-',
                        msg: result.message || 'X…ôta'
                    });
                    
                    showResult(data);
                }
                
            } catch (e) {
                console.error(e);
                
                const data = {
                    resultType: 'error',
                    name: 'Baƒülantƒ± x…ôtasƒ±',
                    id: '-',
                    type: '-',
                    statusText: 'Server…ô qo≈üulmadƒ±'
                };
                
                addScan({
                    ok: false,
                    name: 'Baƒülantƒ± x…ôtasƒ±',
                    id: '-',
                    msg: 'Server…ô qo≈üulmadƒ±'
                });
                
                showResult(data);
            }
        }

        function updateStatus(type, text) {
            const s = document.getElementById('status');
            s.className = 'status status-' + type;
            s.textContent = text;
        }

        function addScan(item) {
            const time = new Date().toLocaleTimeString('az-AZ');
            scanHistory.unshift({...item, time});
            if (scanHistory.length > 10) scanHistory.pop();
            
            const list = document.getElementById('scanList');
            list.innerHTML = scanHistory.map(scan => {
                let icon, cls;
                if (scan.ok) { icon = '‚úì'; cls = 'ok'; }
                else if (scan.warn) { icon = '‚ö†'; cls = 'warn'; }
                else { icon = '‚úï'; cls = 'err'; }
                
                return `
                    <div class="scan-item">
                        <div class="scan-icon ${cls}">${icon}</div>
                        <div class="scan-info">
                            <div class="scan-name">${scan.name}</div>
                            <div class="scan-detail">${scan.id} ${scan.type ? '| ' + scan.type : ''} | ${scan.msg}</div>
                            <div class="scan-time">${scan.time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Kamera ba≈ülat
        function startCamera() {
            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (text) => {
                    if (!isProcessing) handleScan(text);
                },
                () => {}
            ).catch(err => {
                updateStatus('error', 'Kamera a√ßƒ±lmadƒ±!');
                console.error(err);
            });
        }

        window.onload = startCamera;
        
        window.onbeforeunload = () => {
            if (html5QrCode) html5QrCode.stop();
            if (countdownInterval) clearInterval(countdownInterval);
        };
    </script>
</body>
</html>
