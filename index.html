<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>GHG Yem…ôk Talonu</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    /* (S…ônin dizaynƒ±nƒ± saxladƒ±m ‚Äì qƒ±saltmƒ±ram) */
    :root{--navy-950:#050b16;--navy-900:#070f1f;--navy-850:#09142a;--navy-800:#0b1732;--blue-500:#2b6cff;--text:#eaf1ff;--muted:rgba(234,241,255,.72);--stroke:rgba(255,255,255,.10);--shadow:0 22px 70px rgba(0,0,0,.62);--shadow2:0 14px 46px rgba(0,0,0,.55);--radius:22px;--speed:240ms;--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px);--safe-left:env(safe-area-inset-left,0px);--safe-right:env(safe-area-inset-right,0px);}
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;min-height:100dvh;color:var(--text);
      background:radial-gradient(1200px 900px at 18% 12%, #061634 0%, transparent 55%),
               radial-gradient(900px 700px at 88% 22%, #07122a 0%, transparent 52%),
               radial-gradient(800px 650px at 55% 85%, #040a18 0%, transparent 60%),
               linear-gradient(140deg, var(--navy-950) 0%, var(--navy-900) 40%, var(--navy-850) 100%);
      padding:calc(14px + var(--safe-top)) calc(14px + var(--safe-right)) calc(14px + var(--safe-bottom)) calc(14px + var(--safe-left));
      overflow-x:hidden;
    }
    .wrap{max-width:1060px;margin:0 auto;position:relative}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(12px);}
    .page{transition:opacity var(--speed) ease, transform var(--speed) ease;}
    .pageHide{opacity:0;transform:translateY(12px);pointer-events:none;}
    .pageShow{opacity:1;transform:translateY(0);pointer-events:auto;}
    .btn{width:100%;border:none;color:white;cursor:pointer;padding:14px 16px;border-radius:16px;font-weight:800;letter-spacing:.2px;
      background:linear-gradient(135deg,#0f2a55 0%,#1f55d9 52%,#103a9d 100%);box-shadow:0 14px 34px rgba(31,85,217,.20);
      transition:transform var(--speed) ease, box-shadow var(--speed) ease, filter var(--speed) ease;position:relative;overflow:hidden;touch-action:manipulation;}
    .btn:disabled{opacity:.65;cursor:not-allowed}
    .btn-outline{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.14);box-shadow:0 12px 40px rgba(0,0,0,.35);}
    .btn-danger{background:linear-gradient(135deg,#5a1515 0%,#ef4444 60%,#951010 100%);box-shadow:0 16px 44px rgba(239,68,68,.16);width:auto;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;border:none;color:#fff;}
    .login{min-height:calc(100dvh - 28px);display:flex;align-items:flex-start;justify-content:center;padding-top:clamp(24px,7vh,72px);}
    .loginCard{padding:26px;border-radius:24px;border:1px solid rgba(255,255,255,.09);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));backdrop-filter:blur(12px);max-width:440px;width:100%;}
    label{display:block;color:rgba(234,241,255,.92);font-weight:800;margin:10px 0 6px;}
    input{width:100%;padding:14px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.045);color:var(--text);outline:none;font-size:16px;}
    .error{margin-top:12px;padding:12px;border-radius:14px;border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#ffd7d7;display:none;font-weight:700;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;margin-top:10px;}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.055);font-weight:800;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:12px;}
    @media(min-width:900px){.grid{grid-template-columns:1.55fr .95fr;align-items:start;}}
    .section{padding:18px;}
    .ticketGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(min-width:700px){.ticketGrid{grid-template-columns:repeat(4,1fr);}}
    .ticket{border-radius:18px;padding:16px 14px;border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 12px 35px rgba(0,0,0,.34);cursor:pointer;position:relative;overflow:hidden;user-select:none;touch-action:pan-y;}
    .ticket .icon{font-size:36px}
    .ticket .name{font-weight:950;margin-top:8px}
    .ticket .time{color:var(--muted);font-weight:700;font-size:12px;margin-top:4px}
    .badge{margin-top:10px;display:inline-flex;padding:6px 10px;border-radius:999px;font-size:11px;font-weight:900;letter-spacing:.3px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.78);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;touch-action:none;}
    .modal.show{display:flex!important;}
    .modalCard{width:100%;max-width:430px;padding:18px;border-radius:22px;border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg, rgba(6,12,22,.92), rgba(4,8,16,.92));box-shadow:var(--shadow);backdrop-filter:blur(10px);text-align:center;}
    .qrBox{width:250px;height:250px;margin:16px auto 10px;padding:14px;border-radius:18px;background:rgba(255,255,255,.97);display:grid;place-items:center;box-shadow:0 16px 44px rgba(0,0,0,.50);overflow:hidden;}
    .qrBox img{width:220px;height:220px;image-rendering:pixelated;}
    .qrStatusText{width:100%;height:100%;display:grid;place-items:center;color:#0b1732;font-weight:950;font-size:18px;background:rgba(0,0,0,.06);border-radius:14px;}
    .stars{display:flex;justify-content:center;gap:10px;margin:12px 0 10px;}
    .starBtn{font-size:32px;background:none;border:none;cursor:pointer;color:rgba(255,255,255,.28);touch-action:manipulation;}
    .starBtn.active{color:#ffbf2f;}
    textarea{width:100%;min-height:120px;padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.07);color:var(--text);outline:none;resize:vertical;font-size:15px;}
    #qrPreRender{position:fixed;left:-99999px;top:-99999px;width:1px;height:1px;overflow:hidden;opacity:0;pointer-events:none;}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOGIN -->
    <div class="login page pageShow" id="loginPage">
      <div class="loginCard">
        <div style="text-align:center;font-weight:900;font-size:20px;margin-bottom:6px;">GHG Yem…ôk</div>
        <div style="text-align:center;color:rgba(234,241,255,.72);font-weight:800;margin-bottom:18px;">Elektron talon sistemi</div>

        <div style="text-align:center;color:rgba(234,241,255,.72);font-weight:800;margin-bottom:8px;">
          ƒ∞≈ü√ßi ID v…ô 4 r…ôq…ômli parol il…ô daxil olun
        </div>

        <form onsubmit="handleLogin(event)">
          <label>ƒ∞≈ü√ßi ID</label>
          <input id="employeeId" type="text" inputmode="numeric" autocomplete="username" required />

          <label>Parol (4 r…ôq…ôm)</label>
          <input id="employeePass" type="password" inputmode="numeric" maxlength="4" autocomplete="current-password" required />

          <div style="height:12px"></div>
          <button class="btn" id="loginBtn" type="submit">Daxil ol</button>
          <div class="error" id="errorMsg"></div>
        </form>
      </div>
    </div>

    <!-- APP -->
    <div id="mainApp" class="page pageHide" style="display:none;">
      <div class="glass topbar">
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <span class="chip">üë§ <span id="displayName"></span></span>
          <span class="chip">üÜî <span id="displayId"></span></span>
          <span class="chip" style="color:rgba(234,241,255,.72);" id="dateInfo"></span>
        </div>
        <button class="btn-danger" onclick="logout()">√áƒ±xƒ±≈ü</button>
      </div>

      <div class="grid">
        <div class="glass section">
          <div style="font-weight:900;margin-bottom:10px;">üé´ Talonlarƒ±m</div>
          <div style="padding:12px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);color:rgba(234,241,255,.92);margin-bottom:14px;line-height:1.35;">
            <b>Qaydalar:</b> H…ôr talon √º√ß√ºn h…ôr g√ºn yeni QR yaranƒ±r. (K√∂hn…ô g√ºn QR-i i≈ül…ôm…ôy…ôc…ôk)
          </div>
          <div class="ticketGrid" id="ticketContainer"></div>
        </div>

        <div class="glass section">
          <div style="font-weight:900;margin-bottom:10px;">‚≠ê Yem…ôk qiym…ôtl…ôndirm…ôsi</div>
          <div style="padding:12px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);color:rgba(234,241,255,.92);margin-bottom:12px;line-height:1.35;">
            1‚Äì5 ulduz se√ßin v…ô qƒ±sa s…ôb…ôb yazƒ±n. M…ôlumatlar ‚ÄúYem…ôk qiym…ôtl…ôndirm…ôsi‚Äù sheetin…ô yazƒ±lacaq.
          </div>
          <button class="btn btn-outline" onclick="openRatingModal()">üçΩÔ∏è Yem…ôyi qiym…ôtl…ôndir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR MODAL -->
  <div class="modal" id="qrModal" onclick="closeQRModal(event)">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div style="font-size:18px;font-weight:950;">üé´ Talonunuz hazƒ±rdƒ±r</div>
      <div style="margin-top:8px;color:rgba(234,241,255,.72);font-weight:800;" id="qrTicketInfo"></div>
      <div class="qrBox"><div id="modalQR"></div></div>
      <div style="color:rgba(234,241,255,.72);font-weight:800;margin-bottom:12px;">Kafeteryada skaner…ô g√∂st…ôrin</div>
      <button class="btn btn-outline" onclick="closeQRModal()">Baƒüla</button>
    </div>
  </div>

  <!-- RATING MODAL -->
  <div class="modal" id="ratingModal" onclick="closeRatingModal(event)">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div style="font-size:18px;font-weight:950;">‚≠ê Yem…ôk qiym…ôtl…ôndirm…ô</div>
      <div style="margin-top:8px;color:rgba(234,241,255,.72);font-weight:800;">1‚Äì5 ulduz se√ßin v…ô s…ôb…ôb yazƒ±n</div>

      <div class="stars" id="ratingStars"></div>
      <textarea id="ratingReason" placeholder="M…ôs…ôl…ôn: Yem…ôkl…ôr …ôladƒ±r."></textarea>

      <div style="height:12px"></div>
      <button class="btn" id="ratingSubmitBtn" onclick="submitRating()">G√∂nd…ôr</button>
      <div style="height:10px"></div>
      <button class="btn btn-outline" onclick="closeRatingModal()">Baƒüla</button>
    </div>
  </div>

  <div id="qrPreRender"></div>

  <script>
    /************ CONFIG ************/
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxtHn5BnqLDYJj3HYe_0LZEQtX5B5AjLUUapjUmlj3jn1sCGsZmAIW817qfr9lQlh-i/exec'; // <-- /exec linkini yaz

    const TICKET_TYPES = [
      { id: 'breakfast', name: 'S…ôh…ôr Yem…ôyi', icon: 'üåÖ', time: '06:00‚Äì10:00', code: 'S' },
      { id: 'lunch',     name: 'G√ºnorta Yem…ôyi', icon: 'üåû', time: '12:00‚Äì15:00', code: 'G' },
      { id: 'dinner',    name: 'Ax≈üam Yem…ôyi',   icon: 'üåô', time: '18:00‚Äì21:00', code: 'A' },
      { id: 'dry',       name: 'Quru Talon',     icon: 'üì¶', time: 'H…ôr zaman',   code: 'Q' }
    ];

    let currentEmployee = null;
    let selectedRating = 0;

    // QR cache
    let qrTextCache = {};
    let qrImageCache = {};

    function pad2(n){ return String(n).padStart(2,'0'); }
    function todayStr(){
      const d = new Date();
      return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
    }

    function showError(msg){
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function openModal(id){
      document.getElementById(id).classList.add('show');
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    }
    function hideModal(id){
      document.getElementById(id).classList.remove('show');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
    }

    /************ JSONP ************/
    function fetchJSONP(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        const script = document.createElement('script');

        window[cb] = (data) => {
          delete window[cb];
          script.remove();
          resolve(data);
        };

        const t = setTimeout(() => {
          if (window[cb]) delete window[cb];
          script.remove();
          reject(new Error('Timeout'));
        }, 12000);

        script.onerror = () => { clearTimeout(t); reject(new Error('Load error')); };

        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.head.appendChild(script);
      });
    }

    /************ QR ************/
    function generateDailyQR(type) {
      const date = todayStr();
      const base = `${currentEmployee.id}_${date}_${type.code}_${type.id}`;
      let hash = 0;
      for (let i=0;i<base.length;i++){
        hash = ((hash<<5)-hash)+base.charCodeAt(i);
        hash |= 0;
      }
      const hashCode = Math.abs(hash % 9000 + 1000);
      return `GHG|${currentEmployee.id}|${type.code}|${date}|${hashCode}|${type.id}`;
    }

    function keyFor(typeId){
      return `${currentEmployee.id}_${todayStr()}_${typeId}`;
    }

    function renderQRToDataURL(text){
      return new Promise((resolve)=>{
        const pre = document.getElementById('qrPreRender');
        const holder = document.createElement('div');
        pre.appendChild(holder);

        new QRCode(holder, { text, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.L });

        requestAnimationFrame(()=>{
          const canvas = holder.querySelector('canvas');
          if (canvas){
            const url = canvas.toDataURL('image/png');
            holder.remove();
            return resolve(url);
          }
          const img = holder.querySelector('img');
          if (img){
            if (img.complete && img.naturalWidth){
              const url = img.src;
              holder.remove();
              return resolve(url);
            }
            img.onload = ()=>{ const url = img.src; holder.remove(); resolve(url); };
            img.onerror = ()=>{ holder.remove(); resolve(null); };
            return;
          }
          holder.remove();
          resolve(null);
        });
      });
    }

    function setQRBoxHTML(html){
      document.getElementById('modalQR').innerHTML = html;
    }

    function renderTickets(){
      const container = document.getElementById('ticketContainer');
      container.innerHTML = '';

      TICKET_TYPES.forEach(type=>{
        const card = document.createElement('div');
        card.className = 'ticket';
        card.onclick = ()=> showTicket(type);

        // UI h…ômi≈ü…ô aktiv
        card.innerHTML = `
          <div class="icon">${type.icon}</div>
          <div class="name">${type.name}</div>
          <div class="time">${type.time}</div>
          <div class="badge">AKTƒ∞V</div>
        `;
        container.appendChild(card);
      });
    }

    async function showTicket(type){
      if (!currentEmployee) return;

      document.getElementById('qrTicketInfo').textContent =
        `${currentEmployee.fullName} ‚Ä¢ ${type.name} ‚Ä¢ ${todayStr()}`;

      openModal('qrModal');

      const k = keyFor(type.id);
      if (!qrTextCache[k]) qrTextCache[k] = generateDailyQR(type);

      if (qrImageCache[k]) {
        setQRBoxHTML(`<img alt="QR" src="${qrImageCache[k]}">`);
        return;
      }

      setQRBoxHTML(`<div class="qrStatusText">Y√ºkl…ônir...</div>`);
      const url = await renderQRToDataURL(qrTextCache[k]);
      if (url) qrImageCache[k] = url;
      setQRBoxHTML(url ? `<img alt="QR" src="${url}">` : `<div class="qrStatusText">X…ôta</div>`);
    }

    function closeQRModal(e){
      if (!e || e.target.id === 'qrModal'){
        hideModal('qrModal');
        setQRBoxHTML('');
      }
    }

    /************ Rating ************/
    function renderRatingStars(){
      const wrap = document.getElementById('ratingStars');
      wrap.innerHTML = '';
      for (let i=1;i<=5;i++){
        const b = document.createElement('button');
        b.type='button';
        b.className = 'starBtn ' + (i<=selectedRating ? 'active' : '');
        b.textContent = '‚òÖ';
        b.onclick = ()=>{ selectedRating=i; renderRatingStars(); };
        wrap.appendChild(b);
      }
    }

    function openRatingModal(){
      if (!currentEmployee) return;
      selectedRating = 0;
      document.getElementById('ratingReason').value = '';
      renderRatingStars();
      openModal('ratingModal');
    }
    function closeRatingModal(e){
      if (!e || e.target.id === 'ratingModal') hideModal('ratingModal');
    }

    async function submitRating(){
      const reason = document.getElementById('ratingReason').value.trim();
      const btn = document.getElementById('ratingSubmitBtn');

      if (!selectedRating) return alert('Z…ôhm…ôt olmasa ulduz se√ßin.');
      if (!reason) return alert('S…ôb…ôbi yazƒ±n.');

      btn.disabled = true;
      btn.textContent = 'G√∂nd…ôrilir...';

      try{
        const url = `${SHEET_API_URL}?action=submitRating&employeeId=${encodeURIComponent(currentEmployee.id)}&ratingStars=${encodeURIComponent(selectedRating)}&ratingText=${encodeURIComponent(reason)}`;
        const res = await fetchJSONP(url);
        if (res.status === 'success'){
          alert('Qiym…ôtl…ôndirm…ô g√∂nd…ôrildi ‚úÖ');
          closeRatingModal();
        } else {
          alert(res.message || 'G√∂nd…ôrilm…ôdi');
        }
      }catch(e){
        alert('Baƒülantƒ± x…ôtasƒ±!');
      }finally{
        btn.disabled = false;
        btn.textContent = 'G√∂nd…ôr';
      }
    }

    /************ Login ************/
    async function handleLogin(e){
      e.preventDefault();
      const id = document.getElementById('employeeId').value.trim();
      const pass = document.getElementById('employeePass').value.trim();

      const btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.textContent = 'Yoxlanƒ±lƒ±r...';

      try{
        const url = `${SHEET_API_URL}?action=login&id=${encodeURIComponent(id)}&pass=${encodeURIComponent(pass)}`;
        const data = await fetchJSONP(url);

        if (data.status === 'success'){
          currentEmployee = { id, fullName: data.employee.fullName || '' };
          localStorage.setItem('ghg_employee', JSON.stringify(currentEmployee));

          document.getElementById('loginPage').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          document.getElementById('mainApp').classList.remove('pageHide');
          document.getElementById('mainApp').classList.add('pageShow');

          document.getElementById('displayName').textContent = currentEmployee.fullName;
          document.getElementById('displayId').textContent = currentEmployee.id;
          document.getElementById('dateInfo').textContent = 'üìÖ ' + todayStr();

          qrTextCache = {};
          qrImageCache = {};
          document.getElementById('qrPreRender').innerHTML = '';

          renderTickets();
        } else if (data.status === 'invalid_pass'){
          showError('‚ùå Yanlƒ±≈ü parol!');
        } else if (data.status === 'not_found'){
          showError('‚ùå ƒ∞≈ü√ßi tapƒ±lmadƒ±!');
        } else {
          showError('‚ùå X…ôta: ' + (data.message || 'Nam…ôlum'));
        }
      }catch(err){
        showError('‚ùå Baƒülantƒ± x…ôtasƒ±!');
      }finally{
        btn.disabled = false;
        btn.textContent = 'Daxil ol';
      }
    }

    function logout(){
      localStorage.removeItem('ghg_employee');
      currentEmployee = null;
      selectedRating = 0;
      qrTextCache = {};
      qrImageCache = {};
      document.getElementById('qrPreRender').innerHTML = '';
      hideModal('qrModal'); hideModal('ratingModal');
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('loginPage').style.display = 'flex';
    }

    window.onload = () => {
      const saved = localStorage.getItem('ghg_employee');
      if (saved){
        currentEmployee = JSON.parse(saved);
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('mainApp').classList.remove('pageHide');
        document.getElementById('mainApp').classList.add('pageShow');

        document.getElementById('displayName').textContent = currentEmployee.fullName;
        document.getElementById('displayId').textContent = currentEmployee.id;
        document.getElementById('dateInfo').textContent = 'üìÖ ' + todayStr();

        renderTickets();
      }
    };
  </script>
</body>
</html>
