<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>GHG Yem…ôk Talonu</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --navy-950:#061326;
      --navy-900:#071a33;
      --navy-850:#0b2242;
      --navy-800:#0e2a52;
      --navy-700:#123469;
      --blue-500:#2b6cff;
      --blue-400:#4b86ff;
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.75);
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.14);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 12px 40px rgba(0,0,0,.35);
      --radius: 22px;
      --speed: 260ms;
    }

    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      min-height:100vh;
      color:var(--text);
      background: radial-gradient(1200px 900px at 20% 10%, #0f2f63 0%, transparent 55%),
                  radial-gradient(900px 700px at 90% 20%, #112c54 0%, transparent 50%),
                  linear-gradient(140deg, var(--navy-950) 0%, var(--navy-900) 45%, var(--navy-850) 100%);
      padding:14px;
      overflow-x:hidden;
    }

    /* LOGO BACKDROP */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.10;
      background-image: var(--logo);
      background-repeat:no-repeat;
      background-position: center 20%;
      background-size: 520px auto;
      filter: drop-shadow(0 18px 70px rgba(0,0,0,.8));
      transform: translateY(-12px);
    }

    .wrap{max-width:1060px;margin:0 auto;position:relative}

    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* Animations */
    @keyframes floatIn {
      from { transform: translateY(14px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }
    .animate-in{animation: floatIn 520ms ease both;}

    /* Buttons */
    .btn{
      width:100%;
      border:none;
      color:white;
      cursor:pointer;
      padding:14px 16px;
      border-radius: 16px;
      font-weight:800;
      letter-spacing:.2px;
      background: linear-gradient(135deg, #163a75 0%, #2b6cff 52%, #1b4db8 100%);
      box-shadow: 0 14px 34px rgba(43,108,255,.22);
      transition: transform var(--speed) ease, box-shadow var(--speed) ease, filter var(--speed) ease;
      position:relative;
      overflow:hidden;
    }
    .btn::after{
      content:"";
      position:absolute; inset:-40% -60%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.32), transparent 45%);
      transform: translateX(-35%) rotate(12deg);
      transition: transform 520ms ease;
      opacity:.65;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: 0 18px 52px rgba(43,108,255,.28); }
    .btn:hover::after{ transform: translateX(0) rotate(12deg); }
    .btn:active{ transform: translateY(0); filter:saturate(1.1); }
    .btn:disabled{opacity:.65; cursor:not-allowed; transform:none; box-shadow:none;}

    .btn-outline{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.20);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }

    .btn-danger{
      background: linear-gradient(135deg, #7b1d1d 0%, #ef4444 60%, #b91c1c 100%);
      box-shadow: 0 16px 44px rgba(239,68,68,.18);
      width:auto;
      padding:10px 14px;
      border-radius: 999px;
      font-weight:800;
    }

    /* Login */
    .login{
      min-height: calc(100vh - 28px);
      display:flex; align-items:center; justify-content:center;
    }
    .loginCard{ width:100%; max-width: 430px; padding: 26px; }
    .brand{ display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom: 14px; }
    .brandBadge{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(43,108,255,.30), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.16);
      display:grid;place-items:center;
      box-shadow: var(--shadow2);
      font-weight: 950;
      letter-spacing: .6px;
    }
    .brandTitle{font-size: 22px;font-weight: 900;}
    .brandSub{color:var(--muted); font-weight:600; font-size: 13px; text-align:center; margin-bottom: 18px;}

    label{display:block; color:rgba(234,241,255,.92); font-weight:800; margin: 10px 0 6px;}
    input{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      color: var(--text);
      outline:none;
      transition: border var(--speed) ease, transform var(--speed) ease, background var(--speed) ease;
      font-size: 16px;
    }
    input:focus{
      border-color: rgba(43,108,255,.55);
      background: rgba(255,255,255,.09);
      transform: translateY(-1px);
      box-shadow: 0 0 0 6px rgba(43,108,255,.12);
    }
    .error{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
      color: #ffd7d7;
      display:none;
      font-weight:700;
    }

    /* Header */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      margin-top: 10px;
    }
    .who{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      color:rgba(234,241,255,.95);
      font-weight:800;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    .muted{color:var(--muted);font-weight:700}

    /* Sections */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 12px;
    }
    @media(min-width:900px){
      .grid{ grid-template-columns: 1.55fr .95fr; align-items:start; }
    }
    .section{ padding: 18px; }
    .sectionTitle{
      font-size: 16px;
      font-weight: 900;
      margin-bottom: 10px;
      letter-spacing:.2px;
    }
    .infoBox{
      padding: 12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(234,241,255,.92);
      margin-bottom: 14px;
      line-height:1.35;
    }

    /* Tickets */
    .ticketGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media(min-width:700px){
      .ticketGrid{ grid-template-columns: repeat(4, 1fr); }
    }
    .ticket{
      border-radius: 18px;
      padding: 16px 14px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow: 0 12px 35px rgba(0,0,0,.25);
      cursor:pointer;
      transition: transform var(--speed) ease, box-shadow var(--speed) ease, border var(--speed) ease, filter var(--speed) ease;
      position:relative;
      overflow:hidden;
    }
    .ticket::before{
      content:"";
      position:absolute; inset:-60% -60%;
      background: radial-gradient(circle at 30% 35%, rgba(43,108,255,.28), transparent 45%);
      transform: rotate(10deg);
      opacity:.9;
    }
    .ticket:hover{
      transform: translateY(-4px);
      border-color: rgba(43,108,255,.35);
      box-shadow: 0 16px 48px rgba(0,0,0,.34);
      filter: saturate(1.05);
    }
    .ticket:active{ transform: translateY(-1px) scale(.985); }
    .ticket .icon{ font-size: 36px; position:relative; }
    .ticket .name{ font-weight: 950; margin-top: 8px; position:relative; }
    .ticket .time{ color: var(--muted); font-weight:700; font-size: 12px; margin-top: 4px; position:relative; }
    .badge{
      margin-top: 10px;
      display:inline-flex;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.3px;
      border:1px solid rgba(255,255,255,.18);
      position:relative;
      background: rgba(255,255,255,.06);
    }
    .badge.ok{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
    .badge.used{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.70);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 1000;
    }
    .modalCard{
      width:100%;
      max-width: 430px;
      padding: 18px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(10,24,48,.92), rgba(6,19,38,.92));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      text-align:center;
    }
    .modalTitle{ font-size: 18px; font-weight: 950; }
    .modalSub{ margin-top: 8px; color: var(--muted); font-weight:700; }
    .qrBox{
      width: 250px; height: 250px;
      margin: 16px auto 10px;
      padding: 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.96);
      display:grid; place-items:center;
      box-shadow: 0 16px 44px rgba(0,0,0,.40);
      transform-origin: center;
    }

    /* Rating */
    .stars{display:flex;justify-content:center;gap:10px;margin:12px 0 10px;}
    .starBtn{
      font-size: 32px;
      background:none;
      border:none;
      cursor:pointer;
      color: rgba(255,255,255,.28);
      transition: transform var(--speed) ease, color var(--speed) ease;
    }
    .starBtn:hover{ transform: translateY(-2px) scale(1.03); }
    .starBtn.active{ color: #ffbf2f; text-shadow: 0 10px 26px rgba(255,191,47,.25); }

    textarea{
      width:100%;
      min-height: 120px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      color: var(--text);
      outline:none;
      resize: vertical;
      font-size: 15px;
    }
    textarea:focus{
      border-color: rgba(43,108,255,.55);
      background: rgba(255,255,255,.09);
      box-shadow: 0 0 0 6px rgba(43,108,255,.12);
    }

    .footer{
      text-align:center;
      margin: 16px 0 6px;
      color: rgba(234,241,255,.85);
      font-weight: 900;
      letter-spacing:.5px;
    }

    /* ---------- Pro transitions / micro-interactions ---------- */
    @keyframes modalFade { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modalPop {
      0%   { transform: translateY(14px) scale(.96); opacity: 0; }
      60%  { transform: translateY(-2px) scale(1.01); opacity: 1; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal.show{ display:flex !important; animation: modalFade 220ms ease both; }
    .modal.show .modalCard{ animation: modalPop 320ms cubic-bezier(.2,.9,.2,1) both; }

    @keyframes qrSpinIn {
      0%   { transform: rotate(-14deg) scale(.86); opacity: 0; filter: blur(1px); }
      70%  { transform: rotate(3deg) scale(1.02); opacity: 1; filter: blur(0); }
      100% { transform: rotate(0deg) scale(1); opacity: 1; }
    }
    .qrBox.spinIn{ animation: qrSpinIn 420ms cubic-bezier(.2,.9,.2,1) both; }

    /* Smooth page transitions */
    #loginPage, #mainApp{ transition: opacity 240ms ease, transform 240ms ease; }
    .pageHide{ opacity:0; transform: translateY(10px); pointer-events:none; }
    .pageShow{ opacity:1; transform: translateY(0); }
  </style>
</head>

<body style="--logo: url('');">
  <div class="wrap">

    <!-- LOGIN -->
    <div class="login" id="loginPage">
      <div class="glass loginCard animate-in">
        <div class="brand">
          <div class="brandBadge">GHG</div>
          <div>
            <div class="brandTitle">GHG Yem…ôk</div>
            <div class="muted" style="font-weight:800;font-size:12px;">Elektron talon sistemi</div>
          </div>
        </div>

        <div class="brandSub">ƒ∞≈ü√ßi ID v…ô 4 r…ôq…ômli parol il…ô daxil olun</div>

        <form onsubmit="handleLogin(event)">
          <label>ƒ∞≈ü√ßi ID</label>
          <input id="employeeId" type="text" inputmode="numeric" autocomplete="username" required />

          <label>Parol (4 r…ôq…ôm)</label>
          <input id="employeePass" type="password" inputmode="numeric" maxlength="4" autocomplete="current-password" required />

          <div style="height:12px"></div>
          <button class="btn" id="loginBtn" type="submit">Daxil ol</button>

          <div class="error" id="errorMsg"></div>
        </form>
      </div>
    </div>

    <!-- APP -->
    <div id="mainApp" style="display:none;">
      <div class="glass topbar animate-in">
        <div class="who">
          <span class="chip">üë§ <span id="displayName"></span></span>
          <span class="chip">üÜî <span id="displayId"></span></span>
          <span class="chip muted" id="dateInfo"></span>
        </div>
        <button class="btn-danger" onclick="logout()">√áƒ±xƒ±≈ü</button>
      </div>

      <div class="grid">
        <div class="glass section animate-in">
          <div class="sectionTitle">üé´ Talonlarƒ±m</div>
          <div class="infoBox">
            <b>Qaydalar:</b> H…ôr talon √º√ß√ºn h…ôr g√ºn yeni QR yaranƒ±r. Talonlar bir-birini deaktiv etmir ‚Äî hamƒ±sƒ± aktiv qalƒ±r.
          </div>
          <div class="ticketGrid" id="ticketContainer"></div>
        </div>

        <div class="glass section animate-in">
          <div class="sectionTitle">‚≠ê Yem…ôk qiym…ôtl…ôndirm…ôsi</div>
          <div class="infoBox" style="margin-bottom:12px;">
            1‚Äì5 ulduz se√ßin v…ô qƒ±sa s…ôb…ôb yazƒ±n. M…ôlumatlar ‚ÄúYem…ôk qiym…ôtl…ôndirm…ôsi‚Äù sheetin…ô yazƒ±lacaq.
          </div>
          <button class="btn btn-outline" onclick="openRatingModal()">üçΩÔ∏è Yem…ôyi qiym…ôtl…ôndir</button>
        </div>
      </div>

      <div class="footer">By CED</div>
    </div>

  </div>

  <!-- QR MODAL -->
  <div class="modal" id="qrModal" onclick="closeQRModal(event)">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div class="modalTitle">üé´ Talonunuz hazƒ±rdƒ±r</div>
      <div class="modalSub" id="qrTicketInfo"></div>
      <div class="qrBox"><div id="modalQR"></div></div>
      <div class="muted" style="margin-bottom:12px;">Kafeteryada skaner…ô g√∂st…ôrin</div>
      <button class="btn btn-outline" onclick="closeQRModal()">Baƒüla</button>
    </div>
  </div>

  <!-- RATING MODAL -->
  <div class="modal" id="ratingModal" onclick="closeRatingModal(event)">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div class="modalTitle">‚≠ê Yem…ôk qiym…ôtl…ôndirm…ô</div>
      <div class="modalSub">1‚Äì5 ulduz se√ßin v…ô s…ôb…ôb yazƒ±n</div>

      <div class="stars" id="ratingStars"></div>
      <textarea id="ratingReason" placeholder="M…ôs…ôl…ôn: Yem…ôkl…ôr …ôladƒ±r."></textarea>

      <div style="height:12px"></div>
      <button class="btn" id="ratingSubmitBtn" onclick="submitRating()">G√∂nd…ôr</button>
      <div style="height:10px"></div>
      <button class="btn btn-outline" onclick="closeRatingModal()">Baƒüla</button>
    </div>
  </div>

  <script>
    /************ CONFIG ************/
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbx6LGMoy8noFaGkff4xfmqLxdkssZXPjfFIXQimMluPv7QQwn3T5sBqm8Oe3nh7Y-oV/exec';

    // LOGO URL (buraya logonun linkini yazƒ±n)
    // M…ôs: https://.../ghg.png
    const LOGO_URL = ''; // <- BURANI DOLDURUN
    if (LOGO_URL) document.body.style.setProperty('--logo', `url('${LOGO_URL}')`);

    const TICKET_TYPES = [
      { id: 'breakfast', name: 'S…ôh…ôr Yem…ôyi', icon: 'üåÖ', time: '06:00‚Äì10:00', code: 'S' },
      { id: 'lunch',     name: 'G√ºnorta Yem…ôyi', icon: 'üåû', time: '12:00‚Äì15:00', code: 'G' },
      { id: 'dinner',    name: 'Ax≈üam Yem…ôyi',   icon: 'üåô', time: '18:00‚Äì21:00', code: 'A' },
      { id: 'dry',       name: 'Quru Talon',     icon: 'üì¶', time: 'H…ôr zaman',   code: 'Q' }
    ];

    let currentEmployee = null;
    let selectedRating = 0;
    let usedMap = {}; // ticketId -> true/false

    /************ Modal helpers ************/
    function openModal(id){ document.getElementById(id).classList.add('show'); }
    function hideModal(id){ document.getElementById(id).classList.remove('show'); }

    /************ Date helpers (dd.MM.yyyy) ************/
    function pad2(n){ return String(n).padStart(2,'0'); }
    function todayStr(){
      const d = new Date();
      return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
    }

    /************ QR Generator ************/
    // Format: GHG|EMPID|TYPECODE|DD.MM.YYYY|HASH|TYPEID
    function generateDailyQR(type) {
      const date = todayStr();
      const base = `${currentEmployee.id}_${date}_${type.code}_${type.id}`;
      let hash = 0;
      for (let i = 0; i < base.length; i++) {
        hash = ((hash << 5) - hash) + base.charCodeAt(i);
        hash |= 0;
      }
      const hashCode = Math.abs(hash % 9000 + 1000);
      return `GHG|${currentEmployee.id}|${type.code}|${date}|${hashCode}|${type.id}`;
    }

    /************ JSONP ************/
    function fetchJSONP(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        const script = document.createElement('script');

        window[cb] = (data) => {
          delete window[cb];
          script.remove();
          resolve(data);
        };

        const t = setTimeout(() => {
          if (window[cb]) delete window[cb];
          script.remove();
          reject(new Error('Timeout'));
        }, 12000);

        script.onload = () => clearTimeout(t);
        script.onerror = () => { clearTimeout(t); reject(new Error('Load error')); };

        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.head.appendChild(script);
      });
    }

    function showError(msg){
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    /************ LOGIN ************/
    async function handleLogin(e){
      e.preventDefault();
      const id = document.getElementById('employeeId').value.trim();
      const pass = document.getElementById('employeePass').value.trim();

      const btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.textContent = 'Yoxlanƒ±lƒ±r...';

      try{
        const url = `${SHEET_API_URL}?action=login&id=${encodeURIComponent(id)}&pass=${encodeURIComponent(pass)}`;
        const data = await fetchJSONP(url);

        if (data.status === 'success') {
          currentEmployee = { id, fullName: data.employee.fullName || '' };

          // ‚úÖ ID + PASS yadda saxla (logoutda silinm…ôsin)
          localStorage.setItem('ghg_login_id', id);
          localStorage.setItem('ghg_login_pass', pass);

          // session
          localStorage.setItem('ghg_employee', JSON.stringify(currentEmployee));

          // UI: smooth transition
          const login = document.getElementById('loginPage');
          const app = document.getElementById('mainApp');
          login.classList.add('pageHide');

          setTimeout(async () => {
            login.style.display = 'none';
            app.style.display = 'block';
            app.classList.add('pageShow');

            document.getElementById('displayName').textContent = currentEmployee.fullName;
            document.getElementById('displayId').textContent = currentEmployee.id;
            document.getElementById('dateInfo').textContent = 'üìÖ ' + todayStr();

            await loadUsedStatuses();
            renderTickets();
          }, 220);

        } else if (data.status === 'invalid_pass') {
          showError('‚ùå Yanlƒ±≈ü parol!');
        } else if (data.status === 'not_found') {
          showError('‚ùå ƒ∞≈ü√ßi tapƒ±lmadƒ±!');
        } else {
          showError('‚ùå X…ôta: ' + (data.message || 'Nam…ôlum'));
        }
      }catch(err){
        console.error(err);
        showError('‚ùå Baƒülantƒ± x…ôtasƒ±!');
      }finally{
        btn.disabled = false;
        btn.textContent = 'Daxil ol';
      }
    }

    /************ LOGOUT (ID + PASS qalsƒ±n) ************/
    function logout(){
      // ‚úÖ ID v…ô PAROL qalƒ±r (ghg_login_id / ghg_login_pass toxunmur)
      // ‚úÖ Sessiyanƒ± silirik ki, app a√ßƒ±q qalmasƒ±n
      localStorage.removeItem('ghg_employee');

      // ‚úÖ UI: app-d…ôn login-…ô qayƒ±t (animasiya il…ô)
      const login = document.getElementById('loginPage');
      const app = document.getElementById('mainApp');

      login.style.display = 'flex';
      login.classList.remove('pageHide');
      login.classList.add('pageShow');

      app.classList.add('pageHide');
      setTimeout(() => { app.style.display = 'none'; }, 220);

      // ‚úÖ inputlara yadda≈üdakƒ± ID/PASS-ƒ± yenid…ôn yaz
      const savedId = localStorage.getItem('ghg_login_id') || '';
      const savedPass = localStorage.getItem('ghg_login_pass') || '';
      document.getElementById('employeeId').value = savedId;
      document.getElementById('employeePass').value = savedPass;

      // ‚úÖ error mesajƒ± varsa t…ômizl…ô
      const err = document.getElementById('errorMsg');
      if (err) { err.style.display = 'none'; err.textContent = ''; }

      // ‚úÖ session d…ôyi≈ü…ônl…ôrini d…ô sƒ±fƒ±rla
      currentEmployee = null;
      selectedRating = 0;
      usedMap = {};
    }

    /************ USED STATUS (scanner log) ************/
    async function loadUsedStatuses(){
      usedMap = {};
      const date = todayStr();
      const checks = TICKET_TYPES.map(async (t) => {
        try{
          const url = `${SHEET_API_URL}?action=checkScanStatus&id=${encodeURIComponent(currentEmployee.id)}&ticketType=${encodeURIComponent(t.id)}&date=${encodeURIComponent(date)}`;
          const res = await fetchJSONP(url);
          usedMap[t.id] = (res.status === 'success' && !!res.used);
        }catch(e){
          usedMap[t.id] = false;
        }
      });
      await Promise.all(checks);
    }

    /************ RENDER TICKETS ************/
    function renderTickets(){
      const container = document.getElementById('ticketContainer');
      container.innerHTML = '';

      TICKET_TYPES.forEach(type => {
        const used = !!usedMap[type.id];

        const card = document.createElement('div');
        card.className = 'ticket';
        card.onclick = () => showTicket(type);

        card.innerHTML = `
          <div class="icon">${type.icon}</div>
          <div class="name">${type.name}</div>
          <div class="time">${type.time}</div>
          <div class="badge ${used ? 'used' : 'ok'}">${used ? 'ƒ∞STƒ∞FAD∆è EDƒ∞LDƒ∞' : 'AKTƒ∞V'}</div>
        `;
        container.appendChild(card);
      });
    }

    function showTicket(type){
      const qrData = generateDailyQR(type);

      document.getElementById('qrTicketInfo').textContent =
        `${currentEmployee.fullName} ‚Ä¢ ${type.name} ‚Ä¢ ${todayStr()}`;

      const qrDiv = document.getElementById('modalQR');
      qrDiv.innerHTML = '';

      new QRCode(qrDiv, {
        text: qrData,
        width: 220,
        height: 220,
        correctLevel: QRCode.CorrectLevel.H
      });

      // Spin animation
      const qrBox = document.querySelector('#qrModal .qrBox');
      qrBox.classList.remove('spinIn');
      void qrBox.offsetWidth;
      qrBox.classList.add('spinIn');

      openModal('qrModal');
    }

    function closeQRModal(e){
      if (!e || e.target.id === 'qrModal') hideModal('qrModal');
    }

    /************ RATING ************/
    function renderRatingStars(){
      const wrap = document.getElementById('ratingStars');
      wrap.innerHTML = '';
      for(let i=1;i<=5;i++){
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'starBtn ' + (i <= selectedRating ? 'active' : '');
        b.innerHTML = '‚òÖ';
        b.onclick = () => { selectedRating = i; renderRatingStars(); };
        wrap.appendChild(b);
      }
    }

    function openRatingModal(){
      selectedRating = 0;
      document.getElementById('ratingReason').value = '';
      renderRatingStars();
      openModal('ratingModal');
    }

    function closeRatingModal(e){
      if (!e || e.target.id === 'ratingModal') hideModal('ratingModal');
    }

    async function submitRating(){
      const reason = document.getElementById('ratingReason').value.trim();
      const btn = document.getElementById('ratingSubmitBtn');

      if (!currentEmployee) return alert('∆èvv…ôlc…ô giri≈ü edin.');
      if (!selectedRating) return alert('Z…ôhm…ôt olmasa ulduz se√ßin.');
      if (!reason) return alert('S…ôb…ôbi yazƒ±n.');

      btn.disabled = true;
      btn.textContent = 'G√∂nd…ôrilir...';

      try{
        const url = `${SHEET_API_URL}?action=submitRating&employeeId=${encodeURIComponent(currentEmployee.id)}&ratingStars=${encodeURIComponent(selectedRating)}&ratingText=${encodeURIComponent(reason)}`;
        const res = await fetchJSONP(url);

        if (res.status === 'success'){
          alert('Qiym…ôtl…ôndirm…ô g√∂nd…ôrildi ‚úÖ');
          closeRatingModal();
        } else {
          alert(res.message || 'G√∂nd…ôrilm…ôdi');
        }
      }catch(err){
        console.error(err);
        alert('Baƒülantƒ± x…ôtasƒ±!');
      }finally{
        btn.disabled = false;
        btn.textContent = 'G√∂nd…ôr';
      }
    }

    /************ INIT ************/
    window.onload = async () => {
      // ID/PASS autofill (logoutdan sonra da qalsƒ±n)
      const savedId = localStorage.getItem('ghg_login_id');
      const savedPass = localStorage.getItem('ghg_login_pass');
      if (savedId) document.getElementById('employeeId').value = savedId;
      if (savedPass) document.getElementById('employeePass').value = savedPass;

      const savedEmployee = localStorage.getItem('ghg_employee');
      if (savedEmployee){
        currentEmployee = JSON.parse(savedEmployee);

        document.getElementById('loginPage').style.display = 'none';
        const app = document.getElementById('mainApp');
        app.style.display = 'block';
        app.classList.add('pageShow');

        document.getElementById('displayName').textContent = currentEmployee.fullName;
        document.getElementById('displayId').textContent = currentEmployee.id;
        document.getElementById('dateInfo').textContent = 'üìÖ ' + todayStr();

        await loadUsedStatuses();
        renderTickets();
      }
    };
  </script>
</body>
</html>
